<!--
		Private and confidential Zenith 2019 ver.2.5.1
		Last Update by 05/17/2019 by Zenith
-->
<html>
<head>
    <title>Pro:Centric</title>
    <script type="text/javascript" src="js/hcap.js"></script>
    <script type="text/javascript" src="js/bluebird.min.js"></script>
    <script type="text/javascript" src="js/lodash.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
    <script>
        /**
         * Wrap hcap api functions in to a Promise (with Bluebird.js, ES6 Promise polyfill)
         * currently, hard to figure out which hcap api has a problem and hard to find logs about it.
         * hcap apis are asynchronous so we should manage related async api calls for next step (api -> then -> next api)
         */
        hcapPromise = {
            _exec: function(type, funcName, input) {
                input = input || {};
                //console.error("#: req | "+type+"."+funcName);
                return new Promise(function (resolve, reject) {
                    var onSuccessFunc = input.onSuccess || _.noop;
                    var onFailureFunc = input.onFailure || _.noop;
                    input.onSuccess = function(s) {
                        try { onSuccessFunc(s); } catch (e) { console.error("#: "+type+"."+funcName+" (onSuccess) error : "+e.message) }
                        resolve(s);
                        //console.error("#: onSuccess | "+type+"."+funcName);
                    };
                    input.onFailure = function(f) {
                        try { onFailureFunc(f); } catch (e) { console.error("#: "+type+"."+funcName+" (onFailure) error : "+e.message) }
                        reject(f);
                        console.error("#: onFailure | "+type+"."+funcName);
                    };
                    hcap[type][funcName](input);
                });
            }
        };
        _.keys(hcap).forEach(function(type) {
            if(_.isObject(hcap[type])) {
                hcapPromise[type] = {};
                _.keys(hcap[type]).forEach(function(funcName) {
                    if(_.isFunction(hcap[type][funcName])) {
                        hcapPromise[type][funcName] = function(input, async) {
                            return async
                                ? function(){return hcapPromise._exec(type, funcName, input);}
                                : hcapPromise._exec(type, funcName, input);
                        }
                    }
                });
            }
        });
    </script>
    <script type="text/javascript" src="js/easytimer.min.js"></script>
    <script type="text/javascript" src="js/lz-string.min.js"></script>
    <script type="text/javascript" src="js/logStorage.js"></script>
    <script type="text/javascript" src="js/moment.min.js"></script>
    <script type="text/javascript" src="js/asyncManager.js"></script>
    <script type="text/javascript" src="js/HCAP_TV_Setup.js"></script>
    <script type="text/javascript" src="js/crypto.core.min.js"></script>
    <script type="text/javascript" src="js/2.5.3-crypto-md5.js"></script>
    <script type="text/javascript" src="js/lg_common_tv.js"></script>
    <script type="text/javascript" src="js/common_polling.js"></script>
    <script type="text/javascript" src="js/smartAppsAuthHandler.js"></script>
    <script type="text/javascript" src="js/speech.js"></script>
    <script type="text/javascript" src="js/iot.js"></script>
    <script type="text/javascript" src="js/softap.js"></script>
    <script type="text/javascript" src="js/hashids.min.js"></script>
    <script type="text/javascript" src="js/hmac-sha256.js"></script>
    <script type="text/javascript" src="js/enc-base64-min.js"></script>
    <script type="text/javascript" src="project.js"></script>
    <link rel="stylesheet" href="css/spinner.css" type="text/css">
    <!--<link rel="stylesheet" href="css/wakeupcall.css" type="text/css">-->
    <style type="text/css">
        iframe {
            overflow:hidden;
            border:0;
        }
        .hidden {display:none;}
        .index_console {
            height: 400px;
            width: 100%;
            overflow-y: auto;
            word-wrap: break-word;
            background-color: #eee;
            color: #999;
            border: solid 2px #000;
            padding: 5px;
            margin-top: 2px;
        }
        .page_console {
            height: 400px;
            width: 100%;
            overflow-y: auto;
            word-wrap: break-word;
            background-color: #eee;
            color: #999;
            border: solid 2px #ff0000;
            padding: 5px;
            margin-top: 2px;
        }
        #admin_menu_content {
            font-size: 14px;
            width: 200px;
            padding: 4px;
            position: absolute;
            top: 25px;
            left: 0px;
            z-index: 99999;
            display: none;
            background-color: #999;
            border: solid 1px #000;
        }
        #admin_menu_btn {
            font-size: 14px;
            width: 200px;
            padding: 3px;
            background-color: #999;
            border: solid 1px #000;
        }
        .admin_menu_item {
            display: block;
            background-color: #999;
            color: #000;
            padding: 4px;
        }
        .admin_menu_item:hover {
            background-color: #dedede;
            color: #333;
            cursor: pointer;
        }
        .wakeupcall_popup {
            width: 500px;
            height: 115px;
            line-height: 30px;
            background-color: #fff;
            color: #000;
            font-size: 22px;
            text-align: center;
            padding: 15px;
            display: none;
            position: absolute;
            border: solid 2px #ccc;
            border-radius: 10px;
            box-shadow: 8px 8px 8px #333;
            z-index: 999999;
        }
        .wakeupcall_popup a.confirm-btn {
            width: 100px;
            height: 35px;
            line-height: 35px;
            text-decoration: none;
            outline: none;
            font-size: 21px;
            font-weight: normal;
            color: #000000;
            background-color: white;
            display: inline-block;
            border: solid 1px #000000;
            margin-top: 15px;
        }
        .wakeupcall_popup a.confirm-btn.active {
            color: #ff3355;
            border: solid 1px #ff3355;
        }
    </style>
    <script type="text/javascript">
        var GLOBAL_SERIAL_NO = '';
        var GLOBAL_EVENT_SOURCE = {};
        var CarouselAttemptCount = {};
        var AutoMapNumAttempsExceeded = false;
        var tvDatatimer;
        CarouselAttemptCount.uiConfig = 0;
        CarouselAttemptCount.channels = 0;
        CarouselAttemptCount.tvpms = 0;
        CarouselAttemptCount.event_data = 0;
        var GLOBAL_SERVER_IP = "10.221.44.71";
var GLOBAL_SERVER_PORT = "80";
var COM_TYPE = "IP";
var DATA_CHANNEL = "58000";
var GLOBAL_SECRET = "6143b5a7110566489711696143b5a71105c8595224596143b5a71105e6389249156143b5a71105f4394786976143b5a71106";
var currentXAIT = "223";
var screencast_array = {"status":"success"};
var master_language_array = {"al_AL":{"lang_name":"Albanian","is_default":"0","is_enabled":"0"},"ar_AE":{"lang_name":"Arabic","is_default":"0","is_enabled":"0"},"bs_BA":{"lang_name":"Bosnian","is_default":"0","is_enabled":"0"},"bg_BG":{"lang_name":"Bulgarian","is_default":"0","is_enabled":"0"},"zh_CN":{"lang_name":"Chinese (PRC)","is_default":"0","is_enabled":"0"},"zh_HK":{"lang_name":"Chinese (Hong Kong)","is_default":"0","is_enabled":"0"},"zh_SG":{"lang_name":"Chinese (Singapore)","is_default":"0","is_enabled":"0"},"zh_TW":{"lang_name":"Chinese (Taiwan)","is_default":"0","is_enabled":"0"},"hr_HR":{"lang_name":"Croatian","is_default":"0","is_enabled":"0"},"cs_CZ":{"lang_name":"Czech","is_default":"0","is_enabled":"0"},"da_DK":{"lang_name":"Danish","is_default":"0","is_enabled":"0"},"nl_NL":{"lang_name":"Dutch","is_default":"0","is_enabled":"0"},"en_CA":{"lang_name":"English (CA)","is_default":"0","is_enabled":"0"},"en_GB":{"lang_name":"English (UK)","is_default":"0","is_enabled":"0"},"en_US":{"lang_name":"English (US)","is_default":"1","is_enabled":"1"},"et_EE":{"lang_name":"Estonian","is_default":"0","is_enabled":"0"},"fa_IR":{"lang_name":"Farsi","is_default":"0","is_enabled":"0"},"fi_FI":{"lang_name":"Finnish","is_default":"0","is_enabled":"0"},"fr_FR":{"lang_name":"French","is_default":"0","is_enabled":"0"},"de_DE":{"lang_name":"German","is_default":"0","is_enabled":"0"},"el_GR":{"lang_name":"Greek","is_default":"0","is_enabled":"0"},"he_IL":{"lang_name":"Hebrew","is_default":"0","is_enabled":"0"},"hu_HU":{"lang_name":"Hungarian","is_default":"0","is_enabled":"0"},"it_IT":{"lang_name":"Italian","is_default":"0","is_enabled":"0"},"ja_JP":{"lang_name":"Japanese","is_default":"0","is_enabled":"0"},"kk_KZ":{"lang_name":"Kazakh","is_default":"0","is_enabled":"0"},"ko_KR":{"lang_name":"Korean","is_default":"0","is_enabled":"0"},"lv_LV":{"lang_name":"Latvian","is_default":"0","is_enabled":"0"},"lt_LT":{"lang_name":"Lithuanian","is_default":"0","is_enabled":"0"},"mk_MK":{"lang_name":"Macedonian","is_default":"0","is_enabled":"0"},"no_NO":{"lang_name":"Norwegian","is_default":"0","is_enabled":"0"},"pl_PL":{"lang_name":"Polish","is_default":"0","is_enabled":"0"},"pt_BR":{"lang_name":"Portuguese (Brazil)","is_default":"0","is_enabled":"0"},"pt_PT":{"lang_name":"Portuguese (Portugal)","is_default":"0","is_enabled":"0"},"ro_RO":{"lang_name":"Romanian","is_default":"0","is_enabled":"0"},"ru_RU":{"lang_name":"Russian","is_default":"0","is_enabled":"0"},"sr_RS":{"lang_name":"Serbian","is_default":"0","is_enabled":"0"},"sk_SK":{"lang_name":"Slovak","is_default":"0","is_enabled":"0"},"sl_SI":{"lang_name":"Slovene","is_default":"0","is_enabled":"0"},"es_ES":{"lang_name":"Spanish","is_default":"0","is_enabled":"0"},"sv_SE":{"lang_name":"Swedish","is_default":"0","is_enabled":"0"},"tr_TR":{"lang_name":"Turkish","is_default":"0","is_enabled":"0"},"uk_UA":{"lang_name":"Ukrainian","is_default":"0","is_enabled":"0"},"fr_CA":{"lang_name":"French (CA)","is_default":"0","is_enabled":"0"},"es_MX":{"lang_name":"Spanish (MX)","is_default":"0","is_enabled":"0"}};
var videos_array = [];
var RESOLUTION_WIDTH = 1280;
var RESOLUTION_HEIGHT = 720;
var IS_QMS = 0;
var IS_RMS = 0;
var IS_NEORCHA = 0;
var projectResolution  = 'hd';
var IS_MIA_PROJECT  = 0;
var SERVER_DATE = "Wed, 05 Apr 2023 09:11:43 GMT";
TVSetup("display_resolution","1280x720");
var guide_key_map_type = "";
var guide_key_map_ch = -1;
var pcd_build_version = 'v4.6-1631823201';
var tv_setup = {"status":"success","data":{"checkin":{"volume":"off","power":"off","from":"0","to":"24"}}}.data;
var deploymentMode = 'multicast';
var IS_ADVANCED_WAKEUP_IN_PROJECT = "Y";
var iot_mapping_pages = [];
var epgOnlyEnabled = 0;
localStorage.setItem("dcp",1);
        var RFChangeChannelTimeOut;
        var debugging = false;
        var COOKIE_EXPIRE_DAYS = 365;
        var DATAReady = {};
        var JSON_URL = {};
        var RFVariable = {};
        var startChannelLogicalNumber = 1;
        var startChannelActive = false;
        var uiConfigUseGroups = undefined;
        var roomFound = false;
        var CHANNEL_TYPE = '';
        var CACHE_PATH = '';
        var isAutoMapDone = false; /* network_event_received happens twice on one network event when STB-5500 is tested. */
        var CARAUSEL_PATH ='';
        var DATA_CHANNEL_FREQ=1;
        var media;
        var callId = 0;
        var CALLBACK_FX_ARRAY = {
            callback: function() {},
            referrer: ''
        };
        var CALLBACK_ACTIVE = false;
        var fDoc;
        var tunerNum;
        var VOICE_FOR_STB5500 = false;
        var weather_fetch_minutes_interval = 30;
        var update_carousel_timer;
        var number_of_getroomnumber_retries = 3;
        var defaultFormat = -1;
        var adminMenuState = 'off';
        localStorage.setItem("clearAndReboot", "false");
        localStorage.setItem("pmsStatus","up");
        localStorage.setItem("firstTime", "1");
        localStorage.setItem("autoScroll", "true");

        /* DATAReady is not syncronized with event, carousel_data_cached */
        var DATAReady = {
            data : {
                FetchReTry: 1,
                timeout: false,
                UseGroups: false,
                customApps: false,
                accuweather: false,
                radar: false,
                tvpms: false,
                epg: false,
                uiConfig: false,
                channels: false,
                oneClickService: false,
                groups: false,
                event_data: false,
                videoplayout: false
            }
        };
        _.each(DATAReady.data, function(v, k) {
            Object.defineProperty(DATAReady, k, {
                get: function() {
                    return this.data[k];
                },
                set: function(val) {
                    this.data[k] = val;
                    // only call checkDataReady if current 'val' is true
                    if (val) {
                        checkDataReady();
                    }
                }
            });
        });

        /* When DATAReady is ready, tune to the current channel */
        function checkDataReady() {
            //logIndexConsole("{bootup} Checking bootup sequence...")
            // Used in DEBUG page
            localStorage.setItem("DATAReady", JSON.stringify(DATAReady));

            // Prevent from executing if 'fetchcomplete' has already happened.
            // After bootup sequence has completed, everything should be handled in their proper callbacks
            if (!IS_MIA_PROJECT && getCookie("fetchcomplete") == '') {
                //   logIndexConsole(JSON.stringify(DATAReady));
                if (DATAReady.uiConfig && DATAReady.UseGroups && localStorage.getItem("loadingGroupData") == null) {
                    localStorage.setItem("loadingGroupData", "true");
                    //logIndexConsole('if (DATAReady.uiConfig && DATAReady.UseGroups)');
                    pullChannels("groups.json", getGroupsData);
                }

                if (localStorage.firstTime === "1" && DATAReady.groups && CHANNEL_TYPE == 'IP_DATA' && (fDoc.document.getElementById('lg_video') !== null || fDoc.document.getElementById('pip') !== null)) {
                    if (fDoc.document.getElementById('lg_video') !== null)  //WEBCOMM19-796
                        tuneToStartChannel(fDoc.updateWidgets);
                    else
                        tuneToStartChannel();
                    localStorage.removeItem("firstTime");
                }

                var weather_pass = false;
                if (COM_TYPE != 'RF' || (COM_TYPE == 'RF' && DATAReady.accuweather && DATAReady.radar)) {
                    weather_pass = true;
                }

                var epg_pass = false;
                if (DATAReady.event_data || (COM_TYPE == 'RF' && CarouselAttemptCount.event_data > 3)) {
                    epg_pass = true;
                }

                var pms_pass = false;
                if (DATAReady.tvpms || COM_TYPE == 'IP' || (COM_TYPE == 'RF' && getCookie("pmsType") != 'LEGACY')) {
                    pms_pass = true;
                }

                if (weather_pass && pms_pass && epg_pass && DATAReady.uiConfig && (DATAReady.channels || DATAReady.groups)) {
                    logIndexConsole("NON-MIA BOOTUP SEQUENCE FOR ROOM NUMBER " + getRoomNumber()
                        + ", WITH XAIT " + currentXAIT + " IS COMPLETE!", LOG_MESSAGE_TYPES.milestone_completed);


                    if(CHANNEL_TYPE == 'RF_DATA') {
                        if(RFChangeChannelTimeOut != "undefined"){
                            clearTimeout(RFChangeChannelTimeOut);
                        }

                        if (RFVariable.TV_MODE !== hcap.power.PowerMode.WARM) {
                            if (GLOBAL_SOUND_SETTING != 2) {
                                var tmp_current_channel = getCookie('current_channel');
                                if(RFVariable.currentPageName === "weather" || RFVariable.currentPageName === "billing") {
                                    // This allows event_data.json enough time to cache, otherwise data channel is released before it finishes.
                                    setTimeout(function() {
                                        logIndexConsole("{bootup} This is weather or billing page!!!");
                                        if (getCookie("imagefetchdone") == 'true' && getCookie("weatherfetchdone") == 'true') {
                                            releaseDatachannelForCarousel(true);
                                        }
                                        else if (RFVariable.currentPageName === "billing" && (getCookie("pmsfetchdone") == 'true')) {
                                            releaseDatachannelForCarousel(true);
                                        }
                                    }, 3000);
                                }
                                else if((typeof tmp_current_channel === "undefined" || tmp_current_channel == 'NaN') && fDoc.document.getElementById('lg_video') === null) {
                                    setTimeout(function() {
                                        logIndexConsole("{bootup} Tunning to Start Channel (from checkDataReady)");
                                        tuneToStartChannel();
                                    }, 3000);
                                }
                                else {
                                    // if cookie is set, then initial boot sequence has already completed, don't need to update widgets again.
                                    if (getCookie("fetchcomplete")=='') {
                                        if (fDoc.document.getElementById('lg_video') !== null) {
                                            RFVariable.videoWidgetInPortal = 1;
                                            fDoc.updateWidgets('checkDataReady - CASE 1');
                                        } else {
                                            var physical_channel = getPhysicalChannelInfo(tmp_current_channel);
                                            if (!_.isUndefined(physical_channel) && !_.isEmpty(physical_channel)) {
                                                setTimeout(function () {
                                                    changeChannel(physical_channel, 0, 1, '{bootup} Tunning to Current Channel (from checkDataReady)', null);
                                                }, 3000);
                                            }
                                        }
                                    }
                                }
                            }
                            else if (GLOBAL_SOUND_SETTING == 2) {
                                if (IS_TV_WIDGET_IN_PORTAL == 'Y' && (RFVariable.currentPageName !== "weather" && RFVariable.currentPageName !== "billing")) {
                                    parent.tuningCh();
                                }
                            }
                        }
                    }
                    else {
                        if(fDoc.document.getElementById('lg_video') !== null || fDoc.document.getElementById('pip') !== null) {
                            fDoc.updateWidgets('checkDataReady - CASE 2');
                        }
                    }

                    setCookie("fetchcomplete", true, COOKIE_EXPIRE_DAYS);

                    trimApplicationMilestoneHistory();
                }
                else {
                    var missing_data = '';
                    if (!weather_pass) missing_data+= " [accuweather/radar]";
                    if (!pms_pass) missing_data+= " [tvpms]";
                    if (!epg_pass) missing_data+= " [event_data]";
                    if (!DATAReady.uiConfig) missing_data+= " [uiConfig]";
                    if (!DATAReady.channels && !DATAReady.groups) {
                        missing_data+= " [channels/groups]"
                    }
                    logIndexConsole("NON-MIA Bootup sequence is still waiting for: " + missing_data);
                }
            }
        }

        //For RF adaptation.
        RFVariable.TV_MODE = -1;
        RFVariable.isMuteOn = 0;
        RFVariable.POWER_MODE = 0;
        RFVariable.currentPageName = "none";
        RFVariable.videoWidgetInPortal = 0;
        window.releaseDataChanelCriteria = [];
        window.POWER_MODE_CHANNEL_CHANGE_REFERRER = "POWER_MODE_CHANNEL_CHANGE_REFERRER";

        /* *****************************
         GLOBAL DEBUGGING VARIABLES
         Valid values: @string "FALSE" or "TRUE"
         ***************************** */
        localStorage.setItem("INDEX_DEBUG", "FALSE");

        /*prevent hide portal until data fetch complete*/
        localStorage.setItem("allowHide", false);

        var counter_for_monitor = 9;
        var counter_for_server_ping = 0;
        var mainMonitorObj = {
            room_number: '',
            serial_number: '',
            model_name: '',
            platform_version: '',
            micom_version: '',
            power_mode: '',
            ip_address: '',
            mac_address: '',
            ptc_version: ''
        };

        function initBootupVolume() {
            var tvVolume = undefined;
            if (typeof tv_setup != 'undefined' && isCheckedIn()) {
                logIndexConsole("GUEST CHECKIN IN in initBootupVolume");

                if(_.has(tv_setup.checkin, "volume") && tv_setup.checkin.volume != 'off') {
                    tvVolume = parseInt(tv_setup.checkin.volume);
                }

                if(typeof tvVolume != 'undefined'){
                    hcap.volume.getVolumeLevel({
                        "onSuccess": function (s) {
                            setTimeout(function () {
                                hcap.volume.setVolumeLevel({
                                    'level': tvVolume,
                                    'onSuccess': function () {
                                        localStorage.setItem("tv_sound", s.level);
                                    },
                                    'onFailure': function (f) {
                                    logIndexConsole('onFailure : errorMessage = ' + f.errorMessage);
                                    }
                                });
                            }, 1000);
                        },
                        "onFailure": function (f) {
                    logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                        }
                    });
                }
            }

            //set Max Volume Allowed (Only EU)
            if (_.has(tv_setup, 'tv_max_volume')) {
                hcap.property.setProperty({
                    "key": "maximum_volume_level",
                    "value": tv_setup.tv_max_volume.volume,
                    "onSuccess": function (s) {
                        logIndexConsole("{bootup} Successfully set max volume to " + tv_setup.tv_max_volume.volume);
                    },
                    "onFailure": function(e){
                        logIndexConsole('{bootup} Unable to set maximum volume level ' + e.errorMessage);
                    }
                })
            }
        }

        function initBootupBrowserSecurityLevel() {
            //if browser security level != 1 reboot TV
            hcapPromise.property.getProperty({"key": "browser_https_security_level"})
                .then(
                    function (s) {
                        if (s.value != 1) {
                            hcapPromise.property.setProperty({
                                "key": "browser_https_security_level",
                                "value": "1",
                                "onSuccess": function () {
                                    logIndexConsole("{utilities} Reset browser_https_security_level");
                                    reboot();
                                    return;
                                },
                                "onFailure": function (f) {
                                    logIndexConsole("{utilities} browser_https_security_level Failure : errorMessage = " + f.errorMessage);
                                }
                            });
                        }
                    },
                    function (f) {
                        logIndexConsole("{utilities} onFailure : errorMessage = " + f.errorMessage);
                    }
                );
        }


        /* This is subfunction that is used within index_startup() */
        function index_startup_subfunction() {
            /* Set session id */
            session_id = setUniqueSessionID();

            setCookie("lastbootup", Date.now(), COOKIE_EXPIRE_DAYS);
            setCookie("hcap_focused", "1", COOKIE_EXPIRE_DAYS);
            setCookie('speech_channel', -1, COOKIE_EXPIRE_DAYS);

            setCachePath().then(function(result) {
                /*For Single tuner at the RF mode*/
                logIndexConsole("SUCCESSFULLY DETERMINED CAROUSEL PATH AND METHOD OF DELIVERY!", LOG_MESSAGE_TYPES.milestone_completed);

                getTunerNumber();
                tunerNum = localStorage.getItem("tunerNum");
                logIndexConsole("Current TV has [" + tunerNum + "] tuner(s)");

                // Ping Server
                if (COM_TYPE != 'RF') {
                    pingServerAndStartAutomapSequence();
                } else {
                    // Initialize IoT in RF
                    iotController.init();
                }

                initBootupVolume();

                /* get WebOS version */
                hcap.property.getProperty({
                    "key": "hcap_middleware_version",
                    "onSuccess": function(s) {
                        _.each({
                            "1":    /1\.18\.\d+(\.\d+)?/,
                            "2":    /1\.19\.\d+(\.\d+)?/,
                            "3":    /1\.20\.\d+(\.\d+)?/,
                            "3.5":  /1\.21\.\d+(\.\d+)?/,
                            "4":    /1\.22\.\d+(\.\d+)?/,
                            "4.5":  /1\.23\.\d+(\.\d+)?/,
                            "5":    /1\.24\.\d+(\.\d+)?/
                        }, function(v, k){
                        if (!_.isEmpty(s.value.match(v))) {
                            setCookie('webos', k, COOKIE_EXPIRE_DAYS);
                        }});
                    },
                    "onFailure": function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    }
                });

                initBootupBrowserSecurityLevel();

                if (!IS_MIA_PROJECT) {
                    if (typeof IS_ADVANCED_WAKEUP_IN_PROJECT != 'undefined' && IS_ADVANCED_WAKEUP_IN_PROJECT == "Y") {
                        disableStartVolume();
                    }

                    setGuideKeyMap();
                    TVSetup("tv_caption_ui", "0");
                }
            }, function(err) {
                logIndexConsole("{bootup} Error: " + JSON.stringify(err)); // Error: "It broke"
                /* ******************************************************************
                 DO NOT CALL THIS AGAIN!!!
                 IF there's an error thrown anywhere above it will keep running
                 'setCachePath' in an infinite loop!
                 setCachePath();
                 ****************************************************************** */
            });

            // Set TV_MODE to current power state
            hcap.power.getPowerMode({
                "onSuccess" : function(s) {
                    RFVariable.TV_MODE = s.mode;
                },
                "onFailure" : function(f) {
                    logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                }
            });
        }

        function pingServerAndStartAutomapSequence() {
            logIndexConsole("In pingServerAndStartAutomapSequence with attempt " + counter_for_server_ping);
            counter_for_server_ping++;

            var tcp_listener_active = localStorage.getItem('tcp_listener_active');
            logIndexConsole("{bootup} tcp_listener_active: " + tcp_listener_active);

            var ping_server_allowed = false;
            if(IS_MIA_PROJECT) {
                if (typeof fDoc.setSystemStatus == 'function' && tcp_listener_active != null) {
                    ping_server_allowed = true;
                }
            }
            else if (tcp_listener_active != null) {
                ping_server_allowed = true;
            }

            if (ping_server_allowed) {
                logIndexConsole("Pinging SERVER...", LOG_MESSAGE_TYPES.information);
                pingServer()
                    .then(function (param) {
                        logIndexConsole("Server is up!", LOG_MESSAGE_TYPES.milestone_completed);
                        if (IS_MIA_PROJECT) {
                            fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.Network_Up);
                        }
                        // only start automap if ping was successful
                        if (COM_TYPE == 'IP') {
                            logIndexConsole("Starting autoMapSequence!", LOG_MESSAGE_TYPES.information);
                            autoMapSequence();
                        }
                    }, function(err){
                        if (counter_for_server_ping > 20) {
                            logIndexConsole("Unable to ping server on try " + counter_for_server_ping + ". Exceeded 20 attempts", LOG_MESSAGE_TYPES.error);
                            logIndexConsole("PING ERROR: " + JSON.stringify(err), LOG_MESSAGE_TYPES.error);
                            logMilestoneEvent("SERVER UNREACHABLE");
                        } else {
                            // try again
                            pingServerAndStartAutomapSequence();
                        }
                        //throw new Error("Unable to ping server " + JSON.stringify(err));
                    });
            }
            else {
                logIndexConsole("{bootup} Waiting for 'tcp_listener' to start...")
            }
        }

        //App startup function
        function index_startup() {
            try {

            if (!debugging) {
                var iframeObject = document.getElementsByTagName("iFrame")[0];
                if (iframeObject){
                    iframeObject.contentWindow.focus();
                }
            }

            fDoc = getIframeObject();
            var timer = setTimeout(function () {
                logIndexConsole("{bootup} Failed to reach HCAP API. Page will reload...");
                document.location.href = 'index.html?' + Date.now();
            }, 60000);

                //call to make sure HCAP is responsive?
                hcap.mode.getHcapMode({
                    "onSuccess": function (s) {
                        clearTimeout(timer);
                    },
                    "onFailure": function (f) {
                        logIndexConsole("HCAP MODE FAILUTE: " + f.errorMessage);
                    }
                });

                if (!IS_MIA_PROJECT) {
                    localStorage.setItem("master_language_array", JSON.stringify(master_language_array));

                    hcap.key.addKeyItem({
                        "keycode": 0x00000000,
                        "virtualKeycode": hcap.key.Code.INPUT,
                        "attribute": 2,
                        "onSuccess": function () {
                        },
                        "onFailure": function (param) {
                        }
                    });

                    //Initialize speech JS library
                    var speech_counter = 0;
                    var speechInterval = setInterval(function () {
                        if (typeof initSpeech === 'function') {
                            clearInterval(speechInterval);
                            initSpeech();
                            voiceHandler.initVoice();
                        } else {
                            speech_counter++;
                            logIndexConsole("{bootup} Waiting for speech.js to load [" + speech_counter + "]");
                            if (speech_counter >= 50) {
                                logIndexConsole("{bootup} Gave up on waiting for speech.js to load");
                                clearInterval(speechInterval);
                            }
                        }
                    }, 50);
                }

                if (typeof setByTvSetup == 'function') {
                    setByTvSetup();
                }

                // Skip most of bootup sequence in MIA and reset_memory check was invoked.
                var reset_memory_reload = localStorage.getItem('reset_memory_reload');

                if (IS_MIA_PROJECT && localStorage.getItem('reset_memory_reload') != null) {
                    logIndexConsole("{bootup} App recovering from memory crash - bypass standard bootup sequence");

                    // restore the number of retries flag
                    number_of_getroomnumber_retries = 3;

                    // remove memory reset flag
                    localStorage.removeItem('reset_memory_reload');
                    localStorage.removeItem('verified_system_ready');

                    tunerNum = localStorage.getItem("tunerNum");
                    logIndexConsole("Current TV has [" + tunerNum + "] tuner(s)");

                    /* Set session id */
                    session_id = setUniqueSessionID();

                    initBootupVolume();
                    initBootupBrowserSecurityLevel();

                    if (localStorage.getItem('DATAReady') != null) {
                        logIndexConsole("{bootup} Found 'DATAReady' in storage, retrieving...");
                        var tmp_DATAReady = JSON.parse(localStorage.getItem('DATAReady'));

                        logIndexConsole("DATAReady: " + localStorage.getItem('DATAReady'));
                        isAutoMapDone = true;
                        var tcp_listener_active = localStorage.getItem('tcp_listener_active');
                        logIndexConsole("{bootup} tcp_listener_active: " + tcp_listener_active);

                        var eventsInterval = setInterval(function () {
                            if (typeof fDoc.dispatchNewEvent == 'function' && tcp_listener_active != null) {
                                clearInterval(eventsInterval);

                                if (tmp_DATAReady.data.videoplayout) {
                                    logIndexConsole("{data} SUCCESSFULLY FOUND VIDEOPLAYOUT DATA");
                                    DATAReady.videoplayout = true;
                                    fDoc.dispatchNewEvent('data_ready', 'videoplayout', null);
                                }

                                if (tmp_DATAReady.data.customApps) {
                                    logIndexConsole("{data} SUCCESSFULLY FOUND STARTAPPS DATA");
                                    DATAReady.customApps = true;
                                    fDoc.dispatchNewEvent('data_ready', 'customApps', null);
                                }


                                if (tmp_DATAReady.data.channels) {
                                    logIndexConsole("{data} SUCCESSFULLY FOUND CHANNELS DATA");
                                    DATAReady.channels = true;
                                    fDoc.dispatchNewEvent('data_ready', 'channels', null);
                                }

                                if (tmp_DATAReady.data.event_data) {
                                    logIndexConsole("{data} SUCCESSFULLY FOUND EPG DATA");
                                    DATAReady.event_data = true;
                                    fDoc.dispatchNewEvent('data_ready', 'event_data', null);
                                }

                                if (tmp_DATAReady.data.accuweather) {
                                    logIndexConsole("{data} SUCCESSFULLY FOUND WEATHER DATA");
                                    DATAReady.accuweather = true;
                                    fDoc.dispatchNewEvent('data_ready', 'weather', null);
                                }

                                DATAReady.tvpms = true;
                                DATAReady.uiConfig = true;

                                verifySystemReady('reset_memory check was invoked');
                            } else {
                                logIndexConsole("{bootup} MIA reset mode - Waiting for 'tcp_listener' to start...")
                            }
                        }, 100);
                    } else {
                        logIndexConsole("{bootup} Unable to find DATAReady in storage");
                    }
                } else {
                    expireAllCookies();
                    logMilestoneEvent('REBOOT START');
                    localStorage.setItem("last_reboot_date", moment().unix());

                    hcap.property.getProperty({
                        "key": "room_number",
                        "onSuccess": function (s) {
                            var value = s.value;
                            if (!value) {
                                value = "blank_" + Math.random();
                            } else {
                                setCookie("roomnumber", s.value, COOKIE_EXPIRE_DAYS);
                                if (value.indexOf("[TV]") > -1) {
                                    value = value.replace("[TV]", "");
                                    setCookie("tvID", value, COOKIE_EXPIRE_DAYS);
                                } else {
                                    setCookie("roomnumber", value, COOKIE_EXPIRE_DAYS);
                                }
                            }
                            // source of truth for room_number
                            localStorage.setItem("room_number", value);
                            mainMonitorObj.room_number = value;

                            // continue to bootup
                            index_startup_subfunction();

                        },
                        "onFailure": function (f) {
                            logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                            if (number_of_getroomnumber_retries > 0) {
                                // decrement number of retries
                                number_of_getroomnumber_retries--;

                                logIndexConsole("{bootup} onFailure : FAILED to get Room Number from HCAP, restarting index_startup(). Attempts left: " + number_of_getroomnumber_retries + ", Details: " + f.errorMessage);

                                setTimeout(function () {
                                    index_startup();
                                }, 1000 * 5);
                            } else {
                                logIndexConsole("{bootup} failed to get room number 3 times, so lets CONTINUE to bootup");
                                logMilestoneEvent("FAILED TO GET ROOM NUMBER");
                                // failed to get room number 3 times, so lets continue to bootup
                                index_startup_subfunction();
                            }
                        }
                    });

                    if (!IS_MIA_PROJECT) {
                        if (typeof IS_ADVANCED_WAKEUP_IN_PROJECT != 'undefined' && IS_ADVANCED_WAKEUP_IN_PROJECT == "Y") {
                            disableStartVolume();
                        }

                        setGuideKeyMap();
                        TVSetup("tv_caption_ui", "0");
                    }
                }
            } catch (error) {
                logIndexConsole("ERROR in index_startup: " + error, LOG_MESSAGE_TYPES.error);
            }
        }

        function autoMapSequence() {
            if (typeof tvDataRetries != "undefined" && tvDataRetries && tvDataRetries > 10) {
                AutoMapNumAttempsExceeded = true;
                logMilestoneEvent("EXCEEDED AUTOMAP ATTEMPTS[" + tvDataRetries + "]");
                return;
            }

            var tvDataRetries = 0;
            var tvDatatimer = setInterval(function () {
                tvDataRetries++;
                logIndexConsole("{bootup} GETTING TV DATA - ATTEMPT " + tvDataRetries, LOG_MESSAGE_TYPES.information);
                if (tvDataRetries < 10) {
                    startMonitorObj() //gather TV information
                        .then(function (data) {
                            AutoMapNumAttempsExceeded = false;
                            logIndexConsole("{bootup} counter_for_monitor " + counter_for_monitor);
                            localStorage.setItem('tv_data', JSON.stringify(mainMonitorObj));
                            clearInterval(tvDatatimer);
                            autoMapTV()
                                .then(function (token) {
                                    logIndexConsole("Local Time: " + moment().format('MM/DD/YYYY HH:mm:ss ZZ'));
                                    logIndexConsole("UTC Time: " + moment().utc().format('MM/DD/YYYY HH:mm:ss ZZ'));

                                    //fetch data from AM
                                    getServerTime()
                                        .then(function (res) {
                                            if (!_.isUndefined(fDoc) && fDoc.window.currentPage != "popup_007") {
                                                fDoc.goto("portal");
                                            }
                                            fetchEventData();
                                            fetchWeather();
                                            fetchRoomStatus();
                                            getLGServiceVersion();

                                            if (CHANNEL_TYPE == 'RF_DATA' && deploymentMode != 'unicast') {
                                                logIndexConsole("Checking DataChannel Signal Strength");
                                                if (tunerNum == 1) {
                                                    tuneToDataChannel(getDataChSignalStatus, true);
                                                } else {
                                                    getDataChSignalStatus();
                                                }
                                            }
                                        });
                                })
                                .catch(function (error) {
                                    logIndexConsole("{bootup} autoMapTV failed " + error);
                                });
                        })
                        .catch(function (error) {
                            logIndexConsole("{bootup} startMonitorObj failed " + error);
                        });
                } else {
                    logIndexConsole("{boot} FAILED TO GET TV DATA NUM OF ATTEMPTS EXCEEDED  " + tvDataRetries);
                    if (IS_MIA_PROJECT) {
                        logIndexConsole("{boot} FIRING AutoMap FAIL STATE");
                        fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.AutoMap_Fail);
                    }
                    clearInterval(tvDatatimer);
                    AutoMapNumAttempsExceeded = true;
                    logMilestoneEvent("EXCEEDED AUTOMAP ATTEMPTS[" + tvDataRetries + "]");

                }
            }, 5000);
        }


        /* function AutoMap TV */
        function autoMapTV() {
            logIndexConsole("{bootup} In autoMapTV", LOG_MESSAGE_TYPES.information);
            return new Promise(function (resolve, failure) {
                if (isAutoMapDone === true) {
                    logIndexConsole('{bootup} Automap is already done');
                    return;
                }

                /* logIndexConsole('AutoMap attempt: ' + counter_for_monitor);
                 logIndexConsole(JSON.stringify(mainMonitorObj));
                 */

                if (typeof GLOBAL_SECRET != 'undefined' && typeof currentXAIT != 'undefined') {
                    logIndexConsole('Attempting to start AutoMap process...');

                    if (localStorage.getItem("tv_ip_address") != null
                        && localStorage.getItem("tv_ip_address") != "undefined"
                        && localStorage.getItem("tv_ip_address") != "0.0.0.0"
                        && !(localStorage.getItem("tv_ip_address")).match("^169")) {
                        mainMonitorObj.ip_address = localStorage.getItem("tv_ip_address");
                        /*logIndexConsole('////// autoMap tv ip (should match):' + mainMonitorObj.ip_address);*/

                    } else {
                        /* wait 5 minutes and start IP change listener function, which will automap again when IP changes to valid one. */
                        setTimeout(function () {
                            startNetworkChangeListener();
                        }, 1000 * 5 * 60);
                        return;
                    }

                    var epg_fetch_date = localStorage.getItem("epg_fetch_date");
                    if (null == epg_fetch_date) {
                        epg_fetch_date = "n/a";
                    } else {
                        var d = new Date(epg_fetch_date);
                        epg_fetch_date = d.getFullYear() + '-' + parseInt((d.getMonth() + 1)) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                    }

                    //logIndexConsole('before amObject');

                    var xait = currentXAIT + '-' + mainMonitorObj.xait_version;

                    if (IS_MIA_PROJECT && miaPstInfo != null) {
                        var pstVersion = miaPstInfo.version.major + '.' + miaPstInfo.version.minor + '.' + miaPstInfo.version.build;
                    } else if (IS_MIA_PROJECT && miaPstInfo == null) {
                        var pstVersion = null;
                    }

                    var amObject = {
                        'action': 'access_token',
                        'room_number': mainMonitorObj.room_number,
                        'xait_version': xait,
                        'model': mainMonitorObj.model_name,
                        'ip_address': mainMonitorObj.ip_address,
                        'mac_address': mainMonitorObj.mac_address,
                        'firmware': mainMonitorObj.platform_version,
                        'micom': mainMonitorObj.micom_version,
                        'ptc': mainMonitorObj.ptc_version,
                        'epg_fetch_date': epg_fetch_date,
                        'project_version': (pstVersion) ? pstVersion : '1.0',
                        'client_id': mainMonitorObj.serial_number,
                        'client_secret': GLOBAL_SECRET
                    };

                    if (mainMonitorObj.room_number != mainMonitorObj.serial_number) {
                        amObject.room_number = mainMonitorObj.room_number;
                    }

                    // validate monitor object startMonitorObj
                    var validMonitorObjInfo = true;
                    $.each(amObject, function(key, value) {
                        switch(key) {
                            case "micom":
                            case "ptc":
                                break;
                            default:
                                if (!value) {
                                    logIndexConsole("{automap} Missing value for " + key + " in mainMonitorObj!", LOG_MESSAGE_TYPES.error);
                                    logIndexConsole("AUTOMAP Cancelled!", LOG_MESSAGE_TYPES.error);
                                    logMilestoneEvent("AUTOMAP CANCELLED - Invalid/Missing payload data");
                                    validMonitorObjInfo = false;
                                }
                                return false;
                        }
                    });

                    // fail safe to make sure automap isn't missing information
                    // localstorage flag is only cleared when automap is successful, not on reboot
                    // in the future, this is where we'll attempt to reboot the TV once,
                    // since there's no valid explanation that information would be missing
                    // from mainMonitorObj this far into the process
                    if (!validMonitorObjInfo && localStorage.getItem("automap_info_gathering_failed") == null) {
                        logMilestoneEvent("AUTOMAP CANCELLED / REBOOT REQUIRED");
                        return;
                    }

                    //save client id to use it later to refresh the token if necessary
                    localStorage.setItem("client_id", mainMonitorObj.serial_number);
                    localStorage.setItem("model_name", mainMonitorObj.model_name);

                    logIndexConsole('{automap} ' + JSON.stringify(amObject));
                    logIndexConsole('{automap} asyncManagerUrl: ' + getAsyncManagerUri());
                    logIndexConsole('{automap} STARTING AUTOMAP!');
                    logMilestoneEvent('AUTOMAP STARTED');
                    localStorage.setItem("automap_started", true);

                    $.ajax({
                        type: "POST",
                        url: getAsyncManagerUri(),
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(amObject),
                        dataType: "json",
                        cache: false
                    }).done(function (response, status, xhr) {
                        if (response.error) {
                            determineAutomapFailure(response);
                            return;
                        }

                        localStorage.setItem("access_token", response.access_token);
                        localStorage.setItem("refresh_token", response.refresh_token);
                        isAutoMapDone = true;
                        logIndexConsole('{automap} AUTOMAP WAS SUCCESSFUL!', LOG_MESSAGE_TYPES.milestone_completed);
                        localStorage.removeItem("automap_started");
                        localStorage.removeItem("automap_info_gathering_failed");
                        logMilestoneEvent('AUTOMAP SUCCESSFUL');
                        localStorage.setItem("last_auto_map_date", moment().format('MMMM Do YYYY, h:mm:ss a'));

                        fDoc.postMessage('event_resend_am_requests', '*');
                        if (IS_MIA_PROJECT) {
                            dispatchMiaStoredEvents();
                            fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.AutoMap_Complete);
                        } else {
                            setTimeout(function () {
                                // Initialize IoT in IP
                                iotController.init();

                                if (checkAppCerts()) {
                                    logIndexConsole('-- register app tokens');
                                    window.smartAppAuthHandler.init();
                                }
                            }, 1000);
                        }
                        window.requestHandler.init();
                        return resolve(response.access_token);
                    }).fail(function (code, response) {
                        logIndexConsole('{automap} AUTOMAP FAILED!', LOG_MESSAGE_TYPES.error);
                        logIndexConsole('{automap} Response: ' + JSON.stringify(response), LOG_MESSAGE_TYPES.error);
                        logIndexConsole('{automap} CODE: ' + JSON.stringify(code), LOG_MESSAGE_TYPES.error);
                        logMilestoneEvent('AUTOMAP FAILED - ' + JSON.stringify(code) + '. Payload: ' + JSON.stringify(amObject));

                        var time = moment().toString();
                        localStorage.setItem("tv_automap_failed", time);
                        localStorage.removeItem("automap_started");
                    });
                }
                else {
                    GLOBAL_SECRET != 'undefined' && typeof currentXAIT
                    logIndexConsole("Either GLOBAL_SECRET ["+GLOBAL_SECRET+"] or currentXAIT["+currentXAIT+"] are UNDEFINED", LOG_MESSAGE_TYPES.error);
                }
            });
        }

        function determineAutomapFailure(response) {
            var statusCode = response.error.statusCode;
            var message = response.error.message;
            var status = response.status;

            var matches = response.error.match(/\d+\s-\s{"status":"(\w+)","error":{"statusCode":(\d+),"message":"(\w+)"}}/);
            if (matches) {
                statusCode = matches[2];
                status = matches[1];
                message = matches[3];
            } else {
                if (statusCode === 429) { //Automap limit check
                    localStorage.setItem('automap_limit_reached', 'true');
                    fDoc.location = "stats.html";
                } else {
                    logIndexConsole('{automap} AUTOMAP ERROR [' + statusCode + ']: ' + message);
                    localStorage.setItem("tv_automap_failed", moment().format('MMMM Do YYYY, h:mm:ss a'));
                    localStorage.removeItem("automap_started");
                }
            }
            logMilestoneEvent('AUTOMAP FAILED [' + statusCode + '] - ' + message);
        }

        // Function to collect all necessary TV info to automap
        function startMonitorObj() {
            return new Promise(function(resolve, fail){
                var getOnSuccessFunc = function(key, mode) {
                    return function(s) {
                        var val = '';
                        switch (mode) {
                            case 'property':
                                val = s.value;
                                break;
                            case 'power':
                                val = RFVariable.TV_MODE = s.mode;
                                break;
                            case 'ip':
                                val = s.ip;
                                localStorage.setItem("tv_ip_address", val);
                                break;
                            case 'mac':
                                val = s.mac;
                                break;
                        }

                        logIndexConsole("{pre-automap} "+key+" = " + val);
                        mainMonitorObj[key] = val;
                        counter_for_monitor--;
                    }
                };

                logIndexConsole("{pre-automap} STARTING PRE_AUTOMAP SEQUENCE");
                logIndexConsole("{pre-automap} STEP 1: GET SERIAL NUMBER");
                hcapPromise.property.getProperty({key: 'serial_number', onSuccess: getOnSuccessFunc('serial_number', 'property')})
                    .then(logIndexConsole("{pre-automap} STEP 2: GET MODEL NAME"))
                    .then(hcapPromise.property.getProperty({key: 'model_name', onSuccess: getOnSuccessFunc('model_name', 'property')}, true))
                    .then(logIndexConsole("{pre-automap} STEP 3: GET PLATFORM VERSION "))
                    .then(hcapPromise.property.getProperty({key: 'platform_version', onSuccess: getOnSuccessFunc('platform_version', 'property')}, true))
                    .catch(function (err) {
                        counter_for_monitor = 9;
                        logIndexConsole("{pre-automap} 1-3 FAILED");
                        logIndexConsole("Failed to getProperty: " + JSON.stringify(err));
                        logIndexConsole("Trying to startMonitorObj again...");
                        return fail("Failed to getProperty: " + JSON.stringify(err));
                    })
                    .then(logIndexConsole("{pre-automap} STEP 4: GET MICOM "))
                    .then(hcapPromise.property.getProperty({key: 'micom_version', onSuccess: getOnSuccessFunc('micom_version', 'property')}, true))
                    .catch(function () {
                        logIndexConsole("no micom_version");
                        counter_for_monitor--;
                    })
                    .then(logIndexConsole("{pre-automap} STEP 5: GET PTC "))
                    .then(hcapPromise.property.getProperty({key: 'ptc_version', onSuccess: getOnSuccessFunc('ptc_version', 'property')}, true))
                    .catch(function () {
                        logIndexConsole("no ptc_version");
                        counter_for_monitor--;
                    })
                    .then(logIndexConsole("{pre-automap} STEP 6: GET POWER MODE "))
                    .then(hcapPromise.power.getPowerMode({onSuccess: getOnSuccessFunc('power_mode', 'power')}, true))
                    .then(logIndexConsole("{pre-automap} STEP 7: GET NETWORK INFO "))
                    .then(hcapPromise.network.getNetworkInformation({}, true))
                    .then(logIndexConsole("{pre-automap} STEP 8: GET NUMBER OF NETWORK DEVICES "))
                    .then(function (res) {
                        hcapPromise.network.getNumberOfNetworkDevices()
                            .then(function (s) {
                                if (typeof s !== 'object') {
                                    s = {count: 0};
                                    logIndexConsole("{pre-automap} STEP 8 ERROR: the number of network devices not set");
                                } else {
                                    logIndexConsole("{pre-automap} STEP 8 SUCCESS: the number of network devices = " + s.count);
                                    logIndexConsole("{pre-automap} SUB-STEP 1: IP zero and 169 check start");
                                    if (res.ip_address != '0.0.0.0' && !(res.ip_address).match("^169")) {
                                        logIndexConsole("{pre-automap} SUB-STEP 1.A: IP zero and 169 check PASS");

                                        mainMonitorObj["ip_address"] = res.ip_address;
                                        localStorage.setItem("tv_ip_address", res.ip_address);
                                        counter_for_monitor--;

                                    } else {
                                        counter_for_monitor = 9;
                                        logIndexConsole("{pre-automap} SUB-STEP 1.B: IP zero and 169 check FAILED");
                                        logIndexConsole("Trying to startMonitorObj again...");
                                        return fail('Fail to get IP address');
                                    }
                                }
                                for (var i = 0; i < s.count; i++) {
                                    (function (k) {
                                        logIndexConsole("{pre-automap} STEP 9: GET NETWORK DEVICE #" + k + " START");
                                        hcapPromise.network.getNetworkDevice({
                                            "index": k,
                                            "onSuccess": function (r) {
                                                automap_started = localStorage.getItem("automap_started");
                                                if (automap_started == null) {
                                                    logIndexConsole("{pre-automap} Network device #" + k + " found");
                                                    try {
                                                        logIndexConsole("{pre-automap} " + r.ip + " VS " + res.ip_address + "");
                                                    } catch (err) {
                                                        logIndexConsole("{pre-automap} " + r.ip + " ERR: " + err + "");
                                                    }
                                                    if (res.ip_address == r.ip) {
                                                        logIndexConsole("{pre-automap} Device Match # -> CURRENT MAC: " + r.mac);
                                                        mainMonitorObj["mac_address"] = r.mac;
                                                        mainMonitorObj["ip_address"] = res.ip_address;
                                                        localStorage.setItem("tv_ip_address", res.ip_address);
                                                        resolve(true);
                                                    } else {
                                                        logIndexConsole("{pre-automap} NO MATCH#");
                                                    }
                                                }
                                            },
                                            "onFailure": function (r) {
                                                logIndexConsole("{pre-automap} STEP 9 ERROR: GET NETWORK DEVICE onFailure : errorMessage = " + r.errorMessage);
                                                logIndexConsole("Failed to getProperty: network device");
                                                logIndexConsole("Automapping without MAC Address.....");
                                                counter_for_monitor = 0;
                                                mainMonitorObj["mac_address"] = 'ERROR_' + mainMonitorObj["serial_number"];
                                                mainMonitorObj["ip_address"] = res.ip_address;
                                                localStorage.setItem("tv_ip_address", res.ip_address);
                                                logStorage.init(mainMonitorObj.room_number, mainMonitorObj.serial_number);
                                                resolve(true);
                                            }
                                        }).catch(function (err) {
                                            logIndexConsole("{pre-automap} STEP 9: FAILED Failed to getNetworkDevice");
                                            logIndexConsole("{pre-automap} Automapping without MAC Address.....");
                                            counter_for_monitor = 0;
                                            mainMonitorObj["mac_address"] = 'ERROR_' + mainMonitorObj["serial_number"];
                                            mainMonitorObj["ip_address"] = res.ip_address;
                                            localStorage.setItem("tv_ip_address", res.ip_address);
                                            logStorage.init(mainMonitorObj.room_number, mainMonitorObj.serial_number);
                                            resolve(true);
                                        });
                                    })(i);
                                }
                            })
                            .catch(function (err) {
                                logIndexConsole("{pre-automap} STEP 8: FAILED to getNumberOfNetworkDevices");
                                logIndexConsole("{pre-automap} Automapping will have hardcoded MAC Address.....");
                                counter_for_monitor = 0;
                                mainMonitorObj["mac_address"] = 'ERROR_' + mainMonitorObj["serial_number"];
                                mainMonitorObj["ip_address"] = res.ip_address;
                                localStorage.setItem("tv_ip_address", res.ip_address);
                                logStorage.init(mainMonitorObj.room_number, mainMonitorObj.serial_number);
                                resolve(true);
                            });

                        logStorage.init(mainMonitorObj.room_number, mainMonitorObj.serial_number);
                    }).catch(function (err) {
                    logIndexConsole("{pre-automap} 7-10 FAILED");
                    counter_for_monitor = 9;
                    logIndexConsole("Retrying index_startup() again...");
                    return index_startup();
                });
            });
        }

        function dispatchMiaStoredEvents() {
            verifySystemReady('dispatch_mia_events');
            // Display MIA event to PST
            //  logIndexConsole("********************************* Checking dispatchMiaEvent..**********************");
            if (localStorage.getItem("dispatchMiaEvent") != null) {
                logIndexConsole("{bootup} Sending stored checkin/checkout information to PST");
                //logIndexConsole(localStorage.getItem("dispatchMiaEvent"));

                var dispatchMiaEvent = JSON.parse(localStorage.getItem("dispatchMiaEvent"));
                var data = {
                    status: 'success',
                    content: dispatchMiaEvent.data.content
                };

                var volume = dispatchMiaEvent.data.presets["0"].actions[1].volume;
                var pwrMode = (dispatchMiaEvent.data.presets["0"].actions["0"].power == 'off') ? fDoc.CONSTANTS.PowerMode.OFF : fDoc.CONSTANTS.PowerMode.ON;
                var isSwap = (typeof dispatchMiaEvent.isSwap != 'undefined' && dispatchMiaEvent.isSwap == true) ? true : false;
                //logIndexConsole("*** IS SWAP EVENT ["+isSwap+"] ****");
                // logIndexConsole("********************************* POWER MODE "+pwrMode+"**********************");
                setVolumePro(volume);
                localStorage.setItem('tv_sound', volume);
                setVolumePro(-1);

                var hh = new Date().getHours();

                fDoc.dispatchNewEvent(dispatchMiaEvent.name, dispatchMiaEvent.type, data);
                logIndexConsole("{bootup} SENT STORED CHECKIN/CHECKOUT INFORMATION TO PST", LOG_MESSAGE_TYPES.information);

                localStorage.removeItem("dispatchMiaEvent");
                if (dispatchMiaEvent.is_primary_room && dispatchMiaEvent.type == 'checkin' && !isSwap) {

                    switch (pwrMode) {
                        case fDoc.CONSTANTS.PowerMode.OFF:
                            power_warm();
                            break;
                        case fDoc.CONSTANTS.PowerMode.ON:
                            if (tv_setup.checkin.power == "on") {
                                if (hh >= parseInt(tv_setup.checkin.from) && hh < parseInt(tv_setup.checkin.to)) {
                                    //logIndexConsole("********************************* TURN TV [" + pwrMode + "] **********************");
                                    power_normal();
                                } else {
                                    //logIndexConsole("*** Skip Turning TV ON - outside of allowed hours");
                                    power_warm();
                                }
                            } else {
                                //logIndexConsole("********************************* power_change[" + pwrMode + "] **********************");
                                power_change(pwrMode);
                            }
                            break;
                    }
                } else if (dispatchMiaEvent.type == 'checkout') {
                    power_warm();
                }
            }
        }

        /* function startNetworkChangeListener,  AutoMap TV again when IP changes to valid one. */
        function startNetworkChangeListener() {
            hcap.network.getNetworkInformation({
                "onSuccess" : function(s) {
                    //logIndexConsole("startNetworkChangeListener TV IP: " + s.ip_address);

                    if (s.ip_address != '0.0.0.0' && !(s.ip_address).match("^169")) {
                        //logIndexConsole("---- ip changed to non zero, non 169, AutoMapping AGAIN ----- ");
                        //logIndexConsole("Network is UP!");
                        logMilestoneEvent('network up');

                        // This should not be setting to security level 2 UNTIL we determine guest check-in status,
                        // which is done after automap is complete, in fetchRoomStatus. After we prove this to be the case
                        // we can remove this call entirely
                        // unsetClearAndReboot();
                        localStorage.setItem("tv_ip_address", s.ip_address);
                        localStorage.setItem("pmsStatus","up");

                        counter_for_monitor = 0;
                        getCurrentMacAddress();
                        isAutoMapDone = false;
                        AutoMapNumAttempsExceeded = false;
                        try {
                            clearInterval(tvDatatimer);
                        } catch (e) {
                            logIndexConsole(e.message);
                        }
                        setTimeout(function () {
                            autoMapSequence();
                            getRoomStatus();
                            if (IS_MIA_PROJECT) {
                                fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.OK);
                            }
                        }, 10000);
                    } else {
                        setTimeout(function(){  startNetworkChangeListener();  } , 1000 * 5 * 60);
                    }

                },
                "onFailure" : function(f) {
                    logIndexConsole("{bootup} getNetworkInfo onFailure : errorMessage = " + f.errorMessage, LOG_MESSAGE_TYPES.error);
                    setTimeout(function(){  startNetworkChangeListener();  } , 1000 * 5 * 60);
                }
            });
        }

        function getCurrentMacAddress() {
            hcap.network.getNetworkInformation({
                "onSuccess" : function(res) {
                    hcap.network.getNumberOfNetworkDevices({
                        "onSuccess" : function(s) {
                            //logIndexConsole("onSuccess : the number of network devices = " + s.count);
                            for (var i = 0; i < s.count; i++) {
                                (function(k) {
                                    hcap.network.getNetworkDevice({
                                        "index" : k,
                                        "onSuccess" : function(r) {
                                            if (res.ip_address == r.ip && r.ip !="0.0.0.0") {
                                                //logIndexConsole("CURRENT MAC : " + r.mac);
                                                mainMonitorObj["mac_address"] = r.mac;
                                                mainMonitorObj["ip_address"] = res.ip_address;
                                                localStorage.setItem("tv_ip_address", res.ip_address);
                                            }
                                        },
                                        "onFailure" : function(r) {
                                            logIndexConsole("onFailure : errorMessage = " + r.errorMessage);
                                        }
                                    });
                                })(i);
                            }
                        },
                        "onFailure" : function(f) {
                            logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                        }
                    });

                },
                "onFailure" : function(f) {
                    logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                }
            });
        }

        /* Clear the carousel */
        function clearCarousel() {
            hcapPromise.carousel.clearCarouselDataCache({
                "onSuccess": function() {
                    //logIndexConsole("onSuccess");
                    //index_startup();
                },
                "onFailure": function(f) {
                    logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    //index_startup();
                }
            });
        }

        function getDataChSignalStatus() {
            if (COM_TYPE != 'RF') {
                localStorage.setItem('data_ch_signal_strength', '1');
                var signalStatus = null;
                hcapPromise.channel.getChannelSignalStatus({})
                    .then(function (ss) {
                        var dataChSignalStatus = 'SL: ' + ss.signalLevel + ' SNR: ' + ss.snrValue;
                        signalStatus = dataChSignalStatus;
                        return hcapPromise.network.getWifiDiagnostics({});
                    }).then(function (s) {
                    if (s) {
                        logStorage.sendEvent(logStorage.code.STATUS.SIGNAL_STRENGTH, "wifi signal", Number(s.rssi.split(" dBm")[0]));
                        signalStatus += ' RSSI: ' + s.rssi + ' Noise: ' + s.noise;
                    }

                    update_PCN_TV_Property('signalStrength', signalStatus, mainMonitorObj['serial_number']);

                    if (IS_MIA_PROJECT && tunerNum == 1) {
                        tuneToStartChannel(function() {
                            logIndexConsole("{bootup} Retrieved 'signalstrength' successfully. abandoned data channel back to start channel", LOG_MESSAGE_TYPES.milestone_completed);
                        });
                    }
                }).catch(function (err) {
                    logIndexConsole("{bootup} UNABLE TO GET DATA CH SIGNAL STRENGTH HCAP API FAILED +" + JSON.stringify(err), LOG_MESSAGE_TYPES.error);
                })
            }
        }

        function getLGServiceVersion() {
            var lg_service_xml_version = null;
            hcapPromise.property.getProperty({key: "lg_service_xml_version"})
                .then(function (param) {
                        lg_service_xml_version = param.value;
                        localStorage.setItem('lg_service_xml_version', lg_service_xml_version);
                        logIndexConsole("{bootup} Current 'lg_service_xml_version' is: " + lg_service_xml_version, LOG_MESSAGE_TYPES.information);
                        update_PCN_TV_Property('lgServiceVersion', lg_service_xml_version, mainMonitorObj['serial_number']);
                    },
                    function (f) {
                        logIndexConsole("{bootup} Unable to get lg service version: " + f.errorMessage, LOG_MESSAGE_TYPES.error);
                    }
                ).catch(function (err) {
                logIndexConsole("{bootup} Unable to get lg service version, HCAP API failed + " + JSON.stringify(err), LOG_MESSAGE_TYPES.error);
            });
        }

        // function setChannelsForInit(data) {
        //     logIndexConsole("Setting 'channels' to localStorage for Init");
        //     var channelInfo = LZString.compress(JSON.stringify(data));
        //     localStorage.setItem("channellist", channelInfo);
        //     setChannels();
        // }

        //fetchJSONCarouselData function removed I couldn't find any usage in the whole project

        function tuneToStartChannel(callback){
            callback = callback || null;
            if( startChannelActive ) {
                hcap.channel.getStartChannel({
                    "onSuccess" : function(startCh) {
                        logIndexConsole("Tunning to Start Channel [1]");
                        var channel =getLogicalChannelInfo(startCh);
                        if (typeof channel !== "undefined") {
                            changeChannel(channel, 0, 1, 'tuneToStartChannel', callback);
                        }
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    }
                });
            }
            else { // "last watched channel" mode
                logIndexConsole("******************* Change to Start channel when last watched channel mode");
                var temp_startChannelLogicalNumber = getCookie("last_channel");

                if( isNaN(temp_startChannelLogicalNumber) ) {
                    var temp_ch = getPhysicalChannelInfo(startChannelLogicalNumber);

                    setCookie("current_channel", temp_ch.logicalChannelNumber, COOKIE_EXPIRE_DAYS);
                    setCookie("last_channel", temp_ch.logicalChannelNumber, COOKIE_EXPIRE_DAYS);

                    if (typeof temp_ch !== "undefined") {
                        changeChannel(temp_ch, 0, 1, 'tuneToStartChannel', callback);
                    }
                }else{
                    hcap.channel.getCurrentChannel({
                        "onSuccess" : function(s) {
                            var temp_last_ch;
                            var ch = getLogicalChannelInfo(s);

                            if(ch.hasOwnProperty("logicalChannelNumber")) {
                                temp_last_ch =  ch.logicalChannelNumber;
                            }else{
                                temp_last_ch = startChannelLogicalNumber;
                            }

                            var temp_ch = getPhysicalChannelInfo(temp_last_ch);

                            setCookie("current_channel", temp_ch.logicalChannelNumber, COOKIE_EXPIRE_DAYS);
                            setCookie("last_channel", temp_ch.logicalChannelNumber, COOKIE_EXPIRE_DAYS);

                            if (typeof temp_ch !== "undefined") {
                                changeChannel(temp_ch, 0, 1, 'tuneToStartChannel', callback);
                            }
                        },
                        "onFailure" : function(f) {
                            logIndexConsole("FAILURE in getCurrentConfigChannel!");
                            var temp_ch = getPhysicalChannelInfo(startChannelLogicalNumber);

                            setCookie("current_channel", temp_ch.logicalChannelNumber, COOKIE_EXPIRE_DAYS);
                            setCookie("last_channel", temp_ch.logicalChannelNumber, COOKIE_EXPIRE_DAYS);

                            if (typeof temp_ch !== "undefined") {
                                changeChannel(temp_ch, 0, 1, 'tuneToStartChannel', callback);
                            }
                        }
                    });
                }
            }
        }

        function fetchTvPms(){
            var pmsType = getCookie("pmsType");
            if (typeof COM_TYPE === 'undefined' || 'RF' == COM_TYPE || (COM_TYPE == 'IP' && pmsType == 'LEGACY')) {
                logIndexConsole("fetchTvPms scheduled");
                getCarousel(CARAUSEL_PATH + 'tvpms.json');
                if(CHANNEL_TYPE == 'IP_DATA') {
                    getCarousel(CARAUSEL_PATH + 'tvpms.guest.json');
                }
                /* setTimeout(function() {  fetchTvPms(); }, 60000); */
            }
        }

        function fetchRoomStatus() {
            var pmsType = getCookie("pmsType");
            if (pmsType == 'SONIFI' || pmsType == 'OPENAPI') {
                fetchAMData('fetchGuestName', 'ip', function (data) {
                    if (typeof (data) !== 'undefined' && typeof (data.checkedIn) !== 'undefined' && data.checkedIn == true && typeof (data.lastName) !== 'undefined' && data.lastName != 'null' && data.lastName != null) {

                        logIndexConsole('{utilities} Found GUEST information!', LOG_MESSAGE_TYPES.information);
                        if ('null' == data.salutation || null == data.salutation) {
                            data.salutation = '';
                        }
                        localStorage.setItem("salutation", data.salutation);
                        localStorage.setItem("firstName", data.firstName);
                        localStorage.setItem("lastName", data.lastName);
                        updateLanguageCookie(true);
                        updateTvOccupancyStatus('checked-in');
                        if(localStorage.getItem("CHECKIN_STATE") != "swap") {
                            unsetClearAndReboot(function () {
                                var md5 = Crypto.MD5('' + $.now());
                                getAMData('getPaidChannelList', md5);
                            });
                        }
                        logIndexConsole("Guest information is present - setting security level to 2", LOG_MESSAGE_TYPES.information);
                        goHomePro();
                    } else {
                        expireCookie("welcomeMsgDisplayed");
                        logIndexConsole('{utilities} No GUEST information is available', LOG_MESSAGE_TYPES.information);

                        localStorage.removeItem("salutation");
                        localStorage.removeItem("firstName");
                        localStorage.removeItem("lastName");
                        updateTvOccupancyStatus('checked-out');
                        localStorage.removeItem("fullName");
                        updateLanguageCookie(false);
                        setClearAndReboot();
                        logIndexConsole("No guest information is present - setting security level to 1", LOG_MESSAGE_TYPES.information);
                        goHome();
                    }
                    DATAReady.tvpms = true;
                });

                /* Get PMS site */
                window.requestHandler.requestAM('getPmsSite', '', {}, function (res) {
                    logIndexConsole("{get_pms_site} reseult: " + res.status);
                    if (res.status == "success") {
                        setCookie("pmsSite", res.data.name, COOKIE_EXPIRE_DAYS);
                    }
                });
            }
            else if (IS_MIA_PROJECT && getCookie("pmsType") == 'MARRIOTT') {
                getRoomStatus()
                    .then(function (resp) {
                        logIndexConsole("{utilities} getRoomStatus: " + JSON.stringify(resp));
                    });
            } else if (getCookie("pmsType") == 'NONE') {
                expireCookie("welcomeMsgDisplayed");
                removeLocalStorage('guestInfo');
                updateTvOccupancyStatus('checked-out');
                updateLanguageCookie(false);
                setClearAndReboot();
            }
        }

        function fetchWeather() {
            logIndexConsole("{utilities} Fetching new Weather Data");

            if ('RF' == COM_TYPE) {
                window.releaseDataChanelCriteria = [];
                window.releaseDataChanelCriteria.push('accuweather');
                window.releaseDataChanelCriteria.push('radar');

                getCarousel(CARAUSEL_PATH + 'accuweather.json');
                getCarousel(CARAUSEL_PATH + 'radar.png');
            }
            // in MIA fetch weather right away
            else if (IS_MIA_PROJECT) {
                loadWidgetJSON("", loadWeatherData, "accuweather.json");
                setTimeout(function () {
                    fetchWeather();
                }, 1000*60*window.parent.weather_fetch_minutes_interval);
            }
            // Not MIA, set to 'true' and the widgets will fetch weather themselves.
            else {
                DATAReady.accuweather = true;
                DATAReady.radar = true;
            }
        }

        function fetchSmartapp() {
            logIndexConsole("{utilities} Fetching new Smartapp Data");

            if ('RF' == COM_TYPE) {
                getCarousel(CARAUSEL_PATH + 'uiConfig.json');
	            getCarousel(CARAUSEL_PATH + 'customApps.json');
			}
        }

        function loadWeatherData(dummy, weather_data) {
            //logIndexConsole("RECEIVED LATEST 'weather' data - BEGING PARSING");
            // logIndexConsole("attributes: " + JSON.stringify(attributes));
            // logIndexConsole("weather_data: " + JSON.stringify(weather_data));

            DATAReady.accuweather = true;
            DATAReady.radar = true;

            setCookie("imagefetchdone", true, COOKIE_EXPIRE_DAYS);
            setCookie("weatherfetchdone", true, COOKIE_EXPIRE_DAYS);

            logIndexConsole("{data} SUCCESSFULLY LOADED WEATHER DATA [1]", LOG_MESSAGE_TYPES.milestone_completed);
            if (IS_MIA_PROJECT) {
                fDoc.dispatchNewEvent('data_ready', 'weather', null);
                //logIndexConsole("************ DONE *************");

                verifySystemReady('loadWeatherData');
            }
        }

        function fetchPayChannel(){
            //get carousel (paychannel) every 5 min (RF only)
            if(!_.isUndefined(RFVariable.PayChannelTimer) && !_.isNull(RFVariable.PayChannelTimer) && RFVariable.PayChannelTimer.isRunning()){
                RFVariable.PayChannelTimer.stop();
                RFVariable.PayChannelTimer = null;
            }
            RFVariable.PayChannelTimer = new Timer();
            RFVariable.PayChannelTimer.start({countdown: true, startValues: {minutes: 5}});
            RFVariable.PayChannelTimer.addEventListener('reset', function () {
                getPayChannelData();
            });
            RFVariable.PayChannelTimer.addEventListener('targetAchieved', function () {
                RFVariable.PayChannelTimer = null;
                fetchPayChannel();
                getPayChannelData();
            });

        }

        function getPayChannelData(){
            if(PORTAL_ACTIVE && uiConfigUseGroups && COM_TYPE == "RF" && getCookie("isPmsActive") === "true") {
                if(localStorage.getItem("tunerNum") == "2" ){
                    setTimeout(function() {
                        getCarousel(CARAUSEL_PATH + "addChannels.json");
                    }, 1000);
                } else {
                    tuneToDataChannel(function () {
                        setTimeout(function() {
                            getCarousel(CARAUSEL_PATH + "addChannels.json");
                        }, 500);
                    });
                }
            }
        }

        function setVideoPlayoutData(data) {
            //logIndexConsole("In setVideoPlayoutData.... ");
            /* logIndexConsole("data: " + JSON.stringify(data)); */
            DATAReady.videoplayout = true;

            var videoplayoutCompressed = LZString.compress(JSON.stringify(data));
            localStorage.setItem("videoplayout", videoplayoutCompressed);

            logIndexConsole("{data} SUCCESSFULLY LOADED VIDEOPLAYOUT DATA", LOG_MESSAGE_TYPES.milestone_completed);
            if (IS_MIA_PROJECT) {
                fDoc.dispatchNewEvent('data_ready', 'videoplayout', null);
                /* logIndexConsole("************ DONE *************"); */
            }
        }

        function setGuideKeyMap(){
            var guideButtonChannel = (parseInt(guide_key_map_ch) > 0) ? parseInt(guide_key_map_ch) : -1;
            if (typeof guide_key_map_ch !== "undefined") {
                var guideButtonChannel = (parseInt(guide_key_map_ch) > 0) ? parseInt(guide_key_map_ch) : -1;
            } else {
                guideButtonChannel = -1;
            }
            var euroGuideButtonSet = (guide_key_map_type == 'native') ? 'true' : 'false';
            var portalGuideButtonUsesAppGuide = (guide_key_map_type == 'page') ? true : false;

            if (guideButtonChannel != -1) {
                setCookie("guideButtonChannel", guideButtonChannel, COOKIE_EXPIRE_DAYS);
            } else if (portalGuideButtonUsesAppGuide) {
                expireCookie("guideButtonChannel");
            }

            if (euroGuideButtonSet == 'true') {
                setCookie("euroGuideButtonSet", euroGuideButtonSet, COOKIE_EXPIRE_DAYS);
            }
            else {
                setCookie("euroGuideButtonSet", 'false', COOKIE_EXPIRE_DAYS);
            }

            hcap.key.addKeyItem({
                "keycode": 0x00000000,
                "virtualKeycode": hcap.key.Code.GUIDE,
                "attribute": 2,
                "onSuccess": function() {
                    //logIndexConsole("Guide Key set to Application attribute:2");
                },
                "onFailure": function(param) {
                    logIndexConsole("Removed GUIDE key item: ERROR " + param.errorMessage);
                }
            });
        }

        function disableStartVolume() {
            hcap.property.getHotelMode({
                "onSuccess" : function(s) {
                    logIndexConsole("onSuccess : getHotelMode = " + s.hotelMode);
                    var hotelModeParam = JSON.parse(s.hotelMode);

                    if (hotelModeParam.enable === "on" && hotelModeParam.settings.volume.enable === "on" && hotelModeParam.settings.volume.settings.startVolume.enable === "on") {
                        hotelModeParam.settings.volume.settings.startVolume.enable = "off";
                        hcap.property.setHotelMode({
                            "hotelModeLength" : 4096, /* hotelModeLength (any number) param is needed. Confirmed by AFT */
                            "hotelMode" : JSON.stringify(hotelModeParam),
                            "onSuccess" : function() {
                                logIndexConsole("onSuccess : setHotelMode");
                            },
                            "onFailure" : function(f) {
                                logIndexConsole("onFailure setHotelMode : errorMessage = " + f.errorMessage);
                            }
                        });
                    }
                },
                "onFailure" : function(f) {
                    logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                }
            });
        }

        function getUIConfigData(data) {
            logIndexConsole("PARSING 'uiConfig' DATA", LOG_MESSAGE_TYPES.milestone_completed);
            //try {
            var epgTimeoutSeconds = parseInt(data.epgTimeoutSeconds);
            var instantPowerMode = data.instantPower;
            var apps = data.apps;

            DATAReady.timeout = true;
            DATAReady.uiConfig = true;

            setTVtoWarmMode(instantPowerMode);
            RFVariable.POWER_MODE = instantPowerMode;

            var GMTOffsetInMinutes = parseInt(data.GMTOffsetInMillis) / 60000;
            localStorage.setItem("GMTOffsetInMinutes", GMTOffsetInMinutes);

            startChannelLogicalNumber = parseInt(data.startChannelLogicalNumber);
            startChannelActive = data.startChannelActive;

            pmsType = data.pmsType;
            if (pmsType != null && pmsType != "") {
                setCookie("pmsType", pmsType, COOKIE_EXPIRE_DAYS);
                logIndexConsole("{bootup} Determined PMS TYPE as: " + pmsType);
                if(pmsType == 'NONE'){
                    DATAReady.tvpms=true;
                }

                if (checkAppCerts()) {
                    logIndexConsole('-- register app tokens in uiConfigData');
                    window.smartAppAuthHandler.init();
                }
            }

            //setTVtoWarmMode(instantPowerMode);
            //RFVariable.POWER_MODE = instantPowerMode;

            // Save default language in localStorage var, to allow resetting to default later
            localStorage.setItem("default_language", data.languages[0]);
            localStorage.setItem("languages", data.languages);
            localStorage.setItem("language_reset_hour", parseInt(data.resetTime.hour));
            localStorage.setItem("language_reset_minute", parseInt(data.resetTime.minute));

            updateLanguageCookie(false);

            //logIndexConsole("epgTimeoutSeconds: " + epgTimeoutSeconds);
            if (epgTimeoutSeconds >= 0) {
                setCookie("timeout", epgTimeoutSeconds, COOKIE_EXPIRE_DAYS);
            }

            /* LOAD EPG DATA */
            if (data.epgActive && COM_TYPE == 'RF') {
                fetchEventData();
                getCarousel(CARAUSEL_PATH + 'event_data.json');
            }

            /* LOAD VIDEO PLAYOUT DATA */
            loadJSON(setVideoPlayoutData, 'videoplayout.json', null);

            /* LOAD SMARTAPPS DATA */
            if (Object.keys(apps).length) {
                hcap.preloadedApplication.getPreloadedApplicationList({
                    "onSuccess": function(s) {
                            logConsole("{index.html} Get preloaded applications list");
                            localStorage.setItem("hcapAppList", JSON.stringify(s.list));
                    },
                    "onFailure": function(f) {
                            logConsole("{index.html} onFailure getPreloadedApplicationList : errorMessage = " + f.errorMessage);
                    }
                });

                loadJSON(getSmartAppsData, "customApps.json");
                if(COM_TYPE == "RF") {
                    fetchSmartapp();
                }
            }

            /* LOAD GROUPS/CHANNELS DATA */
            if(data.groupsActive){
                if (typeof deploymentMode !== "undefined" && deploymentMode == 'unicast') {
                    uiConfigUseGroups = true;
                    localStorage.setItem("loadingGroupData", "true");
                    pullChannels("groups.json", getGroupsData);
                    setCookie("groupsfetchdone", true, COOKIE_EXPIRE_DAYS);
                } else {
                    uiConfigUseGroups = true;
                    localStorage.setItem("loadingGroupData", "true");
                    pullChannels("groups.json", getGroupsData);
                    DATAReady.UseGroups = true;
                    setCookie("groupsfetchdone", true, COOKIE_EXPIRE_DAYS);

                    if (COM_TYPE == "RF" && (getCookie("isPmsActive") === "true" || pmsType == "LEGACY")) {
                        //      getCarousel(CARAUSEL_PATH + 'addChannels.json');
                        fetchPayChannel();
                        getPayChannelData();
                    }
                }
            }
            else{
                loadJSON(getChannelsData, "channels.json");
                setCookie("channelsfetchdone", true, COOKIE_EXPIRE_DAYS);
            }

            // If startChannelActive is "undefined", set startChannelActive as true
            if( startChannelActive != "undefined" && startChannelActive == false ) {
                setCookie("videoStartChannelNumber", startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                var temp_startChannelLogicalNumber = parseInt(getCookie("last_channel"));
                if( isNaN(temp_startChannelLogicalNumber) ) {
                    temp_startChannelLogicalNumber = startChannelLogicalNumber;
                }
                var temp_ch = getPhysicalChannelInfo(temp_startChannelLogicalNumber); // Check whether last channel is on channel list or not
                if( Object.keys(temp_ch).length !== 0 ) {
                    startChannelLogicalNumber = parseInt(temp_ch.logicalChannelNumber);
                }
            } else {
                startChannelActive = true;
            }
            setCookie("startChannelActive", startChannelActive, COOKIE_EXPIRE_DAYS);

            if (startChannelLogicalNumber != -1) {
                setCookie("startChannelLogicalNumber", startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                setCookie("current_channel", startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                logIndexConsole("{bootup} Setting startChannelLogicalNumber to " + startChannelLogicalNumber + " | startChannelActive : " + startChannelActive );
            }

            /* LOAD WEATHER DATA */
            if (data.weatherActive && COM_TYPE == 'RF') {
                fetchWeather();
            }
            else if (!IS_MIA_PROJECT) {
                DATAReady.accuweather = true;
                DATAReady.radar = true;
            }

            /* LOAD PMS DATA */
            if(pmsType != null && pmsType != "" && pmsType != "NONE") {

                setCookie("isPmsActive", "true", COOKIE_EXPIRE_DAYS);
                var pmsType = getCookie("pmsType");

                if ('RF' == COM_TYPE || typeof COM_TYPE === 'undefined' || (COM_TYPE == 'IP' && pmsType == 'LEGACY')) {
                    if(CHANNEL_TYPE == 'IP_DATA') {
                        getCarousel(CARAUSEL_PATH + 'tvpms.guest.json');
                    }
                    if(GLOBAL_SOUND_SETTING == 2) {
                        setTimeout(function() {
                            getCarousel(CARAUSEL_PATH + 'tvpms.json');
                        }, 500);
                    } else {
                        getCarousel(CARAUSEL_PATH + 'tvpms.json');
                    }

                } else if ('IP' == COM_TYPE && pmsType != 'LEGACY') {

                    //logIndexConsole("data.pmsActive, trying to fetch TV PMS --------------");

                    if (IS_MIA_PROJECT && pmsType == 'MARRIOTT') {
                        DATAReady.tvpms = true;
                    }
                }

            }
            else {
                setClearAndReboot();
                DATAReady.tvpms = true;
            }

            /* LOAD QMS DATA */
            if (typeof IS_QMS !== 'undefined' && IS_QMS == 1) {
                if (typeof (COM_TYPE) !== 'undefined' && COM_TYPE === 'IP') {
                    if(typeof IS_NEORCHA !== 'undefined' && IS_NEORCHA == '1') {
                        QmsController.init();
                    }
                }
            }

            if (!_.isNull(IS_RMS) && !_.isUndefined(IS_RMS) && IS_RMS) {
                logIndexConsole("*****IS_RMS: " + IS_RMS);
                iotController.redefineFunction((IS_RMS == '2') ? true : false);
            }
            //}
            //catch(e) {
            //    logIndexConsole("getUIConfigData error " + JSON.stringify(e), LOG_MESSAGE_TYPES.error);
            //}

            setCookie("uiconfigfetchdone", true, COOKIE_EXPIRE_DAYS);
            setTimeout(function() {
                localStorage.setItem("allowHide", true);
                localStorage.setItem("keyAllowed", true);
            }, 50);

            if(VOICE_FOR_STB5500 == true) {
                hcap.property.setProperty({
                    "key":"speech_recognition",
                    "value":"1",
                    "onSuccess":function() {
                        logIndexConsole("{bootup} Enabled speech recognition MIC");
                    },
                    "onFailure":function(f) {
                        logIndexConsole("{bootup} Failed to enable speech recoginition MIC");
                    }
                });
            }
        }

        function pullChannels(file,func) {
            logIndexConsole("{bootup} Parsing channels data from " + file);
            /* Bugfix all channels are randomly shown even though TV has the channel group */
            if (file.indexOf("channels.json") !== -1) {
                if (DATAReady.uiConfig) {
                    if (uiConfigUseGroups) {
                        if (DATAReady.groups) {
                            if (roomFound) {
                                file = "groups.json";
                            }
                        } else {
                            return;
                        }
                    }
                } else {
                    return;
                }
            }

            if(file.indexOf("groups.json") !== -1) {
                func = (typeof getGroupsData === "function") ? getGroupsData : _.noop();
            }
            if(UrlExists(CACHE_PATH + file)==200){
                loadJSON(func, CACHE_PATH + file);
            } else{
                loadJSON(func, file);
            }
        }

        function getGroupsData(data) {
            var tmp_channels;
            var roomNumber = getCookie("roomnumber").split("_")[0];
            for (var i in data.groups) {
                for (var j in data.groups[i].rooms) {
                    if (data.groups[i].rooms[j].roomId == roomNumber || data.groups[i].rooms[j].serialNo == getCookie("tvID")) {
                        try {
                            tmp_channels = data.groups[i];
                            if (typeof tmp_channels === 'undefined' || tmp_channels.channels.length == 0) {
                                DATAReady.channels = false;
                            } else {
                                roomFound = true;
                                logIndexConsole("roomFound is set!!!");
                                startChannelLogicalNumber = tmp_channels.startupChannel;
                                if( startChannelActive == false ) {
                                    setCookie("videoStartChannelNumber", startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                                    var temp_startChannelLogicalNumber = parseInt(getCookie("last_channel"));
                                    if( isNaN(temp_startChannelLogicalNumber) ) {
                                        temp_startChannelLogicalNumber = startChannelLogicalNumber;
                                    }
                                    var temp_ch = getPhysicalChannelInfo(temp_startChannelLogicalNumber); // Check whether last channel is on channel list or not
                                    if( Object.keys(temp_ch).length !== 0 ) {
                                        startChannelLogicalNumber = parseInt(temp_ch.logicalChannelNumber);
                                    }
                                }
                                //logIndexConsole("startChannelLogicalNumber in group : " + startChannelLogicalNumber);
                                setCookie("startChannelLogicalNumber", startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                                //Checking PORTAL_ACTIVE due to WEBCOMM18-3088
                                if(PORTAL_ACTIVE == true) {
                                    setCookie('previous_channel', startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                                }
                                //logIndexConsole("PORTAL_ACTIVE : " + PORTAL_ACTIVE + " | previous_channel : " + getCookie("previous_channel") );
                                getChannelsData(tmp_channels);
                                DATAReady.groups = true;
                                if(!_.isNull(localStorage.getItem("paidChannellist")) && _.isNull(countDownTimer)) checkExpiredPaidChannel();
                                /*************************************************************************************/
                                /* WE ARE NOT GOING TO BE UPDATING ANY WIDGETS UNTIL THE BOOTUP SEQUENCE IS COMPLETE */
                                //setTimeout(getIframeObject().updateWidgets(), 1000);
                                /*************************************************************************************/
                            }
                            break;
                        }
                        catch (e) {
                            logIndexConsole("Error stringifying channels :" + JSON.stringify(e));
                        }
                    }
                }
            }

            if (!roomFound) {
                DATAReady.channels = false;
                DATAReady.groups = true;
                pullChannels("channels.json",getChannelsData);
                /*************************************************************************************/
                /* WE ARE NOT GOING TO BE UPDATING ANY WIDGETS UNTIL THE BOOTUP SEQUENCE IS COMPLETE */
                // setTimeout(fDoc.updateWidgets(), 1000);
                /*************************************************************************************/
            }
        }

        function getSmartAppsData(data) {
            try {
                if (data.length > 0) {
                    //logIndexConsole("{data} Setting 'customApps' to localStorage...");
                    localStorage.setItem("customApps", JSON.stringify(data));
                    setCookie("appsfetchdone", true, COOKIE_EXPIRE_DAYS);
                    DATAReady.customApps = true;

                    logIndexConsole("{data} SUCCESSFULLY LOADED SMARTAPPS DATA", LOG_MESSAGE_TYPES.milestone_completed);
                    if (IS_MIA_PROJECT) {
                        fDoc.dispatchNewEvent('data_ready', 'customApps', null);
                        /* logIndexConsole("************ DONE *************"); */
                    }
                }
                else {
                    logIndexConsole("{data} CustomApps file is empty, keeping existing data.");
                    DATAReady.customApps = true;
                }
            }
            catch (e) {
                logIndexConsole("ERR: " + JSON.stringify(e));
            }
        }

        function fetchEventData() {
            logIndexConsole("{utilities} Fetching fresh EPG Data");
            if (COM_TYPE == 'RF') {
                loadJSON(loadEventData, "event_data.json");
            }
            else {
                if (localStorage.getItem('access_token') != "") {
                    loadWidgetJSON("", loadEventData, "event_data.json");
                }
            }
        }

        function loadEventData(param1, param2) {
            logIndexConsole("RECEIVED LATEST 'epg' data - BEGIN PARSING");
            DATAReady.event_data = false;

            var data = {};

            if (COM_TYPE == 'RF') {
                data = param1;
            } else {
                data = param2;
            }

            var eventInfoCompressed = LZString.compress(JSON.stringify(data));
            localStorage.setItem("event_data", eventInfoCompressed);

            if ($.isPlainObject(data) && !$.isEmptyObject(data)) {
                var nowDate = new Date();
                var startDate = new Date(data.startDate);
                var endDate = new Date(startDate.getTime() + data.maxMinutes * 60000);

                //logIndexConsole("nowDate: " + nowDate);
                // logIndexConsole("startDate: " + startDate, LOG_MESSAGE_TYPES.information);
                //logIndexConsole("endDate: " + endDate);

                fetching_fresh_epg_data = getCookie("fetching_fresh_epg_data");
                //logIndexConsole("fetching_fresh_epg_data: " + fetching_fresh_epg_data);

                if (fetching_fresh_epg_data != '') {
                    if (endDate >= nowDate) {
                        //logIndexConsole("*** Date is good!");
                        setCookie("epgfetchdone", true, COOKIE_EXPIRE_DAYS);
                        expireCookie("fetching_fresh_epg_data");
                        expireCookie("epgfailed");

                        // Used in DEBUG page
                        DATAReady.event_data = true;
                        localStorage.setItem("DATAReady", JSON.stringify(DATAReady));

                        logIndexConsole("{data} SUCCESSFULLY LOADED EPG DATA [2]");

                        if (IS_MIA_PROJECT) {
                            fDoc.dispatchNewEvent('data_ready', 'event_data', null);
                            verifySystemReady('loadEventData');
                        } else {
                            var release_data_channel = localStorage.getItem("release_data_channel");
                            logIndexConsole("release_data_channel: " + release_data_channel, LOG_MESSAGE_TYPES.information);
                            if (release_data_channel == 'event_data') {
                                releaseDatachannelForCarousel(true);
                            }
                        }
                    } else {
                        logIndexConsole("{data} EPG Data is still OLD... ", LOG_MESSAGE_TYPES.error);
                        var release_data_channel = localStorage.getItem("release_data_channel");
                        if (release_data_channel == 'event_data') {
                            releaseDatachannelForCarousel(true);
                        }
                    }
                } else {
                    logIndexConsole("{data} SUCCESSFULLY LOADED EPG DATA [1]", LOG_MESSAGE_TYPES.milestone_completed);

                    // Used in DEBUG page
                    localStorage.setItem("DATAReady", JSON.stringify(DATAReady));

                    // Verify if everything is ready and send event to PST
                    DATAReady.event_data = true;
                    setCookie("epgfetchdone", true, COOKIE_EXPIRE_DAYS);
                    expireCookie("fetching_fresh_epg_data");
                    expireCookie("epgfailed");
                    if (IS_MIA_PROJECT) {
                        fDoc.dispatchNewEvent('data_ready', 'event_data', null);
                        /* logIndexConsole("************ DONE *************"); */

                        verifySystemReady('loadEventData');
                    }
                }

                if (DATAReady.event_data) {
                    localStorage.setItem("epg_fetch_date", data.startDate);
                    localStorage.setItem("epg_max_minutes", data.maxMinutes);
                    if (COM_TYPE != 'RF' && isAutoMapDone) {
                        var d = new Date(data.startDate);
                        var epg_fetch_date = d.getFullYear() + '-' + parseInt((d.getMonth() + 1)) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
                        update_PCN_TV_Property("epgFetchDate", epg_fetch_date, mainMonitorObj.serial_number);
                    }
                }
            }
        }

        function getChannelsData(data) {
            // logIndexConsole("Setting 'channels' to localStorage");
            // if(_.isNull(localStorage.getItem("loadingGroupData")) && !_.isUndefined(_.get(getLocalStorageObject("channellist"), 'groupId'))){
            //     data = getLocalStorageObject("channellist");
            // }
            var channelInfo = LZString.compress(JSON.stringify(data));
            localStorage.setItem("channellist", channelInfo);

            setChannels();
            if (typeof channels !== "undefined" && (typeof channels == "object" && Object.keys(channels).length)) {
                /* Set start channel */
                ch = getPhysicalChannelInfo(startChannelLogicalNumber);

                if (!_.isUndefined(ch) && !_.isEmpty(ch)) {
                    var param;

                    var prevChannel = parseInt(getCookie("previous_channel"));
                    if (isNaN(prevChannel) || prevChannel == -1) {
                        //If BGM is set and there is no PIP/VIDEO widget in portal.
                        //Checking PORTAL_ACTIVE due to WEBCOMM18-3088
                        if(PORTAL_ACTIVE == true) {
                            setCookie('previous_channel', startChannelLogicalNumber, COOKIE_EXPIRE_DAYS);
                        }
                    }

                    if (PORTAL_ACTIVE && ((GLOBAL_SOUND_SETTING == 2 && IS_TV_WIDGET_IN_PORTAL == 'N') || IS_VIDEO_WIDGET_IN_PORTAL == 'Y')) {
                        param = getChannelParams(ch, 0, 0, 0, 0, 1);
                    } else {
                        param = getChannelParams(ch, 0, 0, 0, 0, 1);
                        //changeChannel(ch); Removed because in RF we need to wait until we get all the data files before setting to the start channel
                    }

                    localStorage.setItem("callByIndex", true);
                    if( startChannelActive == false ) {
                        param.channelType = 0;
                        logIndexConsole("{bootup} Don't use start channel. channelType is set as " + parseInt(param.channelType) );
                    }
                    if (IS_VIDEO_WIDGET_IN_PORTAL !== "N") {
                        param.channelType = 0;
                    }
                    hcap.channel.setStartChannel(param);

                }
                DATAReady.channels = true;

                logIndexConsole("{data} SUCCESSFULLY LOADED CHANNELS DATA", LOG_MESSAGE_TYPES.milestone_completed);
                if (IS_MIA_PROJECT) {
                    fDoc.dispatchNewEvent('data_ready', 'channels', null);
                    /* logIndexConsole("************ DONE *************"); */

                    verifySystemReady('getChannelsData');
                }
                else {
                    RFVariable.videoWidgetInPortal = 1;
                    if (CHANNEL_TYPE == 'RF_DATA') {
                        //logIndexConsole("****************************************** TUNE TO START CHANNEL");
                        if (RFVariable.TV_MODE !== hcap.power.PowerMode.WARM) {
                            if (GLOBAL_SOUND_SETTING != 2 && IS_VIDEO_WIDGET_IN_PORTAL == 'N') {
                                setTimeout(function () {
                                    tuneToStartChannel();
                                }, 3000);
                            }
                            /*
                            -- REMOVE THIS COMMENT AFTER A MONTH IF NO OBJECTIONS --
                            THIS IS REMOVED TO PREVENT THE WIDGET FROM SWITCHING CHANNELS ON A TIMEOUT
                            AND INSTEAD RELY ON PROPER CALLBACKS / BOOTUP SEQUENCE COMPLETION
                            */
                            // else if (IS_TV_WIDGET_IN_PORTAL == 'Y') {
                            //     /*WEBCOMM18-3113*/
                            //     setTimeout(function () {
                            //         logIndexConsole("****************************************** TUNE TO START PIP WIDGET CHANNEL");
                            //         tuneToStartChannel();
                            //     }, 3000);
                            // }
                            // else if (IS_VIDEO_WIDGET_IN_PORTAL == 'Y') {
                            //     if (fDoc.document.getElementById('lg_video') !== null) {
                            //         logIndexConsole("****************************************** TUNE TO START VIDEO WIDGET CHANNEL");
                            //         setTimeout(function () {
                            //             fDoc.updateWidgets();
                            //         }, 3000);
                            //     }
                            // }
                        } else {
                            if (typeof RFVariable.pmsUpdateWARMmodeTimer === 'undefined') {
                                //DO NOT execute the carousel in case of instantOnMute mode.
                                if (RFVariable.POWER_MODE != 2) {
                                    setTimeout(function () {
                                        updatePMSFromWarmMode();
                                    }, 60000);
                                }
                            }
                        }
                    }else if(CHANNEL_TYPE == 'IP_DATA'){
                        if (GLOBAL_SOUND_SETTING != 2 && IS_VIDEO_WIDGET_IN_PORTAL == 'N') {
                            setTimeout(function () {
                                tuneToStartChannel();
                            }, 3000);
                        }
                    }
                }
            } else {
                logIndexConsole("{data} Unable to load channels data!");
            }
        }

        var countDownTimer = null;
        function checkExpiredPaidChannel(){
            var expiredDate = getCookie("paidchannel_expires");
            var paidchannels = JSON.parse(localStorage.getItem("paidChannellist"));
            var notification = 3;  //before 3 minutes
            var expiredChannels = _.map(_.reject(paidchannels, function(channel){ logIndexConsole(moment(channel.expireDate).unix()); return moment(channel.expireDate).unix() !== parseInt(expiredDate); }), 'logicalChannelNumber');

            if(!_.isNull(countDownTimer) && countDownTimer.isRunning()){
                countDownTimer.stop();
                countDownTimer = null;
            }

            if( expiredDate !== "") {
                countDownTimer = new Timer();
                var duration = moment.duration(moment.unix(expiredDate).diff(moment()), "ms");
                //var fDoc = getIframeObject();

                if (Math.floor(duration.asMinutes()) > notification) {
                    countDownTimer.start({
                        precision: 'minutes',
                        startValues: {minutes: 0},
                        target: {minutes: parseInt(duration.asMinutes() - notification)}
                    });

                    countDownTimer.addEventListener('targetAchieved', function (e) {
                        logIndexConsole('end minutes timer');
                        countDownTimer = null;
                        checkExpiredPaidChannel();

                        if (isWatchingChannel() && fDoc.window.location.href.indexOf("channelbanner.html") > -1) fDoc.init_channel_banner();  //show remaining time in channel banner
                    });
                } else {
                    countDownTimer.start({countdown: true, startValues: {seconds: parseInt(duration.asSeconds())}});

                    countDownTimer.addEventListener('secondsUpdated', function (e) {
                        if (countDownTimer.getTimeValues().seconds == parseInt(getCookie("channelbanner_timeout")) && isWatchingChannel()) {
                            logIndexConsole("secondsUpdated: " + countDownTimer.getTimeValues().toString());
                            if (fDoc.window.location.href.indexOf("channelbanner.html") > -1) fDoc.init_channel_banner(); //show remaining time in channel banner, bannertimeout
                        }
                    });

                    countDownTimer.addEventListener('targetAchieved', function (e) {  //end expired date
                        logIndexConsole('end seconds timer');
                        countDownTimer = null;

                        if (isWatchingChannel()) { //expired channel -> go portal
                            setCookie('previous_channel', getCookie("startChannelLogicalNumber"), COOKIE_EXPIRE_DAYS);
                            expiredChannelToStartChannel();
                            SetPortalStatus(SHOW_PORTAL);
                            goHomePro(function () {
                                setTimeout(updateChannelWidget, 1000);
                            });
                        } else {
                            if (_.indexOf(expiredChannels, parseInt(getCookie('current_channel'))) > -1) {
                                setCookie('previous_channel', getCookie("startChannelLogicalNumber"), COOKIE_EXPIRE_DAYS);
                            }
                            if (PORTAL_ACTIVE && _.indexOf(expiredChannels, parseInt(getCookie('previous_channel'))) > -1) {
                                setCookie('previous_channel', getCookie("startChannelLogicalNumber"), COOKIE_EXPIRE_DAYS);
                            }
                        }
                        setTimeout(setPaidChannelList(paidchannels), 500);  //update paid channel list
                    });
                }
            }

            var isWatchingChannel = function() {
                return (!PORTAL_ACTIVE && getCookie("portal_mode") === PORTAL_MODE_TV)
                    && (paidchannels.length > 0 && _.indexOf(expiredChannels, parseInt(getCookie('current_channel'))) > -1);
            }
        }

        function verifySystemReady(referrer) {
            console.log("VERIFYING IF SYSTEM READY [referrer: " + referrer + "]"); // don't change this to logIndexConsole

            if (IS_MIA_PROJECT) {
                if (COM_TYPE == 'IP' && (DATAReady.accuweather && DATAReady.tvpms && DATAReady.event_data && DATAReady.uiConfig && DATAReady.channels && DATAReady.customApps && isAutoMapDone)) {

                    if (localStorage.getItem("verified_system_ready") == null) {
                        logIndexConsole("MIA BOOTUP SEQUENCE IS COMPLETE!", LOG_MESSAGE_TYPES.milestone_completed);
                        logIndexConsole("{data} ISSUING 'data_ready : fetch_complete' event");
                        setCookie("fetchcomplete", true, COOKIE_EXPIRE_DAYS);

                        fDoc.dispatchNewEvent('data_ready', 'fetch_complete', null);
                        fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.OK);
                        localStorage.setItem("verified_system_ready", true);

                        trimApplicationMilestoneHistory();
                    }
                }
                else {
                    var missing_data = '';
                    if (!DATAReady.accuweather) missing_data+= " [accuweather]";
                    if (!DATAReady.tvpms) missing_data+= " [tvpms]";
                    if (!DATAReady.event_data) missing_data+= " [event_data]";
                    if (!DATAReady.uiConfig) missing_data+= " [uiConfig]";
                    if (!DATAReady.channels) missing_data+= " [channels]";
                    if (!isAutoMapDone) missing_data+= " [isAutoMapDone]";
                    logIndexConsole("MIA Bootup sequence is still waiting for: " + missing_data);
                }
            }
        }

        function restoreMIAPortal() {
            //logIndexConsole("In restoreMIAPortal...");
            window.parent.location.reload();
        }

        function setPageVolumeWithTvwidget() {
            if (localStorage.getItem('checkin_tv_vol') != null) {
                setVolumePro(parseInt(localStorage.getItem('checkin_tv_vol')));
                localStorage.setItem('tv_sound', localStorage.getItem('checkin_tv_vol'));
                localStorage.removeItem('checkin_tv_vol');
            }
            else if (localStorage.getItem('WAKEUPBYADMIN') != null && localStorage.getItem('WAKEUPBYADMIN') == 'ON') {
                localStorage.removeItem('WAKEUPBYADMIN');
                setTvSetupVolume();
            }
        }

        function setPageVolume() {
            if (localStorage.getItem('checkin_tv_vol') != null) {
                if (GLOBAL_SOUND_SETTING == 0) {
                    soundMute();
                } else {
                    setVolumePro(parseInt(localStorage.getItem('checkin_tv_vol')));
                    localStorage.setItem('tv_sound', localStorage.getItem('checkin_tv_vol'));
                }
                localStorage.removeItem('checkin_tv_vol');
            } else if (localStorage.getItem('WAKEUPBYADMIN') != null && localStorage.getItem('WAKEUPBYADMIN') == 'ON') {
                localStorage.removeItem('WAKEUPBYADMIN');
                setTvSetupVolume();
            } else if (GLOBAL_SOUND_SETTING == 0) {
                soundMute();
            }
        }

        function setTvSetupVolume() {
            if (_.has(tv_setup, 'tv_start_up') && parseInt(tv_setup.tv_start_up.volume) > 0) {
                var tvVolume = parseInt(tv_setup.tv_start_up.volume);
                setVolumePro(tvVolume);
                localStorage.setItem('tv_sound', tvVolume);
            }
        }

        function goHome() {
            if(typeof fDoc.SyncBackgroundSettingsToParent === 'function') {
                fDoc.SyncBackgroundSettingsToParent("portal");
            }
            if (typeof fDoc.goto === 'function' && $("Iframe").contents().find("div[id^='page_']").length !== 0) {
                fDoc.goto("portal");
            }
            else {
                try {
                    document.getElementById('iframe_id').setAttribute('src', "portal.html");
                }
                catch (e) {
                    logIndexConsole("ERROR: " + JSON.stringify(e));
                }
            }
        }
        function reloadPage() {
            /* WEBCOMM17-4127 */

            var urlStr = fDoc.location.toString();
            var frameUrl = urlStr.split("/").pop().replace(".html","");
            if(typeof fDoc.SyncBackgroundSettingsToParent === 'function') {
                fDoc.SyncBackgroundSettingsToParent(frameUrl);
            }

            setTimeout(function() {
                $(window.frameElement).addClass("hidden");
                fDoc.location.reload();
            }, 250);
        }

        function expireAllCookies() {
            var expire_localStorage = new Array("access_token", "RESTORE_VOLUME", "running_clear_credentials", "normal_mode_dont_reboot", "token_renew_pending", "fetchAfterPMSup", "clearAndReboot", "last_reboot_date", "DATAReady", "previousChannel", "defaultLanguage", "verified_system_ready", "loadingGroupData", "QMS_SERVICE_LIST", "QMS_JOB_HISTORY", "requestNewOrder", "esStatus", "system_status", "epg_retries", "weather_data", "last_weather_fetch", "get_tv_info_attempt",'data_ch_signal_strength','tcp_data_event_data','automap_started', 'release_data_channel','automap_limit_reached','debugRoomId', 'Launching_SmartApp');
            $.each(expire_localStorage, function(i, ls_name) {
                localStorage.removeItem(ls_name);
            });

            var expire_cookies = new Array("fetching_fresh_epg_data", "startChannelLogicalNumber", "guideButtonChannel", "euroGuideButtonSet", "timeout", "lastbootup", "roomnumber", "portalerror", "session_id", "current_channel", "imagefetchdone", "weatherfetchdone", "customappsfetchdone", "appconfigfetchdone", "pmsfetchdone", "pmsguestfetchdone", "epgfetchdone", "uiconfigfetchdone", "channelsfetchdone", "groupsfetchdone", "oneclickfetchdone", "appsfetchdone", "fetchcomplete", "portal_mode", "channel_filters_set", "vod_playing", "vod_idx", "vod_url", "VOD_ALIVE", "VOD_ACTIVE_URL", "VOD_AUTOMAP_READY", "channelbanner_active", "isPmsActive", "hcap_focused", "switchVODToEPG", "epgfailed", "early_fetch_epg_data_complete", "smartapp_freezetimer", 'startChannelActive', 'videoStartChannelNumber');
            $.each(expire_cookies, function(i, cookie_name) {
                expireCookie(cookie_name);
            });

            logIndexConsole("Deleted all cookies and local storage vars!");
        }

        function setCachePath() {
            logIndexConsole("Determining carousel path and method of delivery");
            var promise = new Promise(function (resolve, reject) {
                hcap.channel.getDataChannel({
                    "onSuccess" : function(s) {
                        if (s.channelType === hcap.channel.ChannelType.RF_DATA) {
                            CHANNEL_TYPE = 'RF_DATA';
                            DATA_CHANNEL_FREQ = s.frequency;
                            CACHE_PATH = "http://127.0.0.1:8051/carousel_cache/" + s.frequency + ".2.2/";
                            CARAUSEL_PATH = "hcap://" + s.frequency + ".2.2/";

                            resolve("Promise Stuff worked! CHANNEL_TYPE: " + CHANNEL_TYPE + " CACHE_PATH: " + CACHE_PATH);
                        } else if (s.channelType === hcap.channel.ChannelType.IP_DATA) {
                            CHANNEL_TYPE = 'IP_DATA';
                            CACHE_PATH = "http://127.0.0.1:8051/carousel_cache/1.2.2/";
                            CARAUSEL_PATH = "hcap://1.2.2/";
                            resolve("Promise Stuff worked! CHANNEL_TYPE: " + CHANNEL_TYPE + " CACHE_PATH: " + CACHE_PATH);
                        } else {
                            CHANNEL_TYPE = 'UNKNOWN';
                            CARAUSEL_PATH = 'UNKNOWN';
                            CACHE_PATH = '';
                            resolve("Promise Stuff worked! CHANNEL_TYPE: " + CHANNEL_TYPE + " CACHE_PATH: " + CACHE_PATH);
                        }
                        localStorage.setItem("CAROUSEL_PATH", CARAUSEL_PATH);
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                        reject(Error("It broke getting the data channel"));
                    }
                });
            });
            return promise;
        }

        function updatePMSFromWarmMode() {
            logIndexConsole("***@@@ update pms from warm mode");

            if(RFVariable.TV_MODE === hcap.power.PowerMode.NORMAL) {
                logIndexConsole("***@@@ Currnet Power mode is Noraml");
                return;
            }

            if(IS_VIDEO_WIDGET_IN_PORTAL == 'Y' && localStorage.getItem("tunerNum") === "1") {
                if(RFVariable.TV_MODE === hcap.power.PowerMode.WARM) {
                    acquireDatachannelForCarousel();
                } else {
                    return;
                }
            }

            /************************************************************
             WHAT DOES WEATHER HAVE TO DO WITH UPDATING PMS???
             *************************************************************
             if(DATAReady.radar && getCookie("imagefetchdone")) {
                setCookie("imagefetchdone", false, COOKIE_EXPIRE_DAYS);
                getCarousel(CARAUSEL_PATH + 'radar.png');
            }
             if(DATAReady.accuweather && getCookie("weatherfetchdone")) {
                setCookie("weatherfetchdone", false, COOKIE_EXPIRE_DAYS);
                getCarousel(CARAUSEL_PATH + 'accuweather.json');
            }
             *************************************************************/

            var pmsType = getCookie("pmsType");
            if (typeof COM_TYPE === 'undefined' || 'RF' == COM_TYPE || (COM_TYPE == 'IP' && pmsType == 'LEGACY')) {
                /*
                 if(DATAReady.tvpms && getCookie("pmsguestfetchdone")) {
                 getCarousel(CARAUSEL_PATH + 'tvpms.guest.json');
                 }
                 */
                if(DATAReady.tvpms && getCookie("pmsfetchdone")) {
                    getCarousel(CARAUSEL_PATH + 'tvpms.json');
                }
                setCookie("pmsfetchdone", false, 1);
            }

            RFVariable.pmsUpdateWARMmodeTimer = setTimeout(function() {
                updatePMSFromWarmMode();
            }, 120000);
        }

        function isEnabledAutoPowerOn() {
            var hh = new Date().getHours();

            logIndexConsole("checkin tv power=" + tv_setup.checkin.power + " auto power on from " + tv_setup.checkin.from + "(hr) to " + tv_setup.checkin.to + "(hr). current time : " + hh);

            return (tv_setup.checkin.power == "on" &&
                (hh >= parseInt(tv_setup.checkin.from) && hh < parseInt(tv_setup.checkin.to))) ? true : false;
        }

        function setAutoPowerOn() {
            if (isEnabledAutoPowerOn()) {
                logIndexConsole("set auto power-on when checked in");
                var roomNo = getCookie("roomnumber");

                if (!_.isNull(roomNo) && ( !(roomNo.toString().toLowerCase().indexOf("_") > 0) || roomNo.toString().toLowerCase().indexOf("_a") > 0 || roomNo.toString().toLowerCase().slice(roomNo.toString().indexOf("_") + 1).length > 1 )) {
                    localStorage.setItem("TurnTvOnAfterReboot", 1);
                }
            }
        }

        function issetTurnTvOnAfterReboot() {
            var turnTvOnAfterReboot = localStorage.getItem("TurnTvOnAfterReboot");
            localStorage.removeItem("TurnTvOnAfterReboot");
            return (!_.isNull(turnTvOnAfterReboot) && parseInt(turnTvOnAfterReboot) == 1) ? true : false;
        }

        // function scrollConsole(direction) {
        //     var y = $(".index_console").scrollTop();
        //
        //     switch(direction) {
        //         case "top":
        //             $('.index_console').scrollTop(0);
        //             break;
        //         case "up":
        //             $('.index_console').scrollTop(y - 50);
        //             break;
        //         case "down":
        //             $('.index_console').scrollTop(y + 50);
        //             break;
        //     }
        // }

        /***************************************************************
         GLOBAL EVENT LISTENERS
         ***************************************************************/
        document.addEventListener(
            "application_registration_result_received", 
            function (param) {
                var res = param.tokenResult;
                logIndexConsole("{event_received} Application registration result received!", LOG_MESSAGE_TYPES.event_received);
                if (!_.isUndefined(res)) {
                    logIndexConsole("id : " + param.id + ",  tokenResult : " + res + ", errorText : " + param.errorText + ", retryCnt : " + smartAppAuthHandler.retryCnt);
                    if (res == "success") {
                        /* update app list */
                        hcap.preloadedApplication.getPreloadedApplicationList({
                            "onSuccess": function(s) {
                                    logConsole("{in application_registration_result_received} Update preloaded applications list");
                                    localStorage.setItem("hcapAppList", JSON.stringify(s.list));
                            },
                            "onFailure": function(f) {
                                    logConsole("{in application_registration_result_received} onFailure getPreloadedApplicationList : errorMessage = " + f.errorMessage);
                            }
                        });

                        logStorage.sendEvent(logStorage.code.STATUS.ACTIVATED_APPS, "activated apps", param.id.replace(/^./, param.id[0].toUpperCase()));

                        /* refresh app list if smartapp widget is in the page */
                        var fDoc = getIframeObject();
                        try {
                            fDoc.updateWidgets();
                        } catch(e) {
                            logIndexConsole("try-catch fDoc.updateWidgets() ");
                        }

                        /* if the app is netflix, add hotkey */
                        if (param.id.toLowerCase() == "netflix") {
                            logIndexConsole('-- add netflix hotkey');
                            /* add netflix hotkey */
                            hcap.key.addKeyItem({
                                "keycode": 0xd32c00ff,
                                "virtualKeycode":hcap.key.Code.POWER,
                                "attribute":0,
                                "onSuccess":function(){
                                    logIndexConsole("Add 3rd party POWER key item: POWER OK");
                                },
                                "onFailure":function(param){
                                    logIndexConsole("Add POWER key item: ERROR " + param.errorMessage);
                                }
                            });
                            hcap.key.addKeyItem({
                                "keycode": 0xd32c01fe,
                                "virtualKeycode":hcap.key.Code.RES_6,
                                "attribute":3,
                                "onSuccess":function(){
                                    logIndexConsole("Add 3rd party NETFLIX (RES_6) key item: OK");
                                },
                                "onFailure":function(param){
                                    logIndexConsole("Add NETFLIX key item: ERROR " + param.errorMessage);
                                }
                            });
                        }
                    } else { 
                        /* retry */
                        if (smartAppAuthHandler.retryCnt++ < 5) {
                            setTimeout(function(){
                                smartAppAuthHandler.init(param.id);
                            } , 1000 * 5);
                        }
                    }
                }
            },
            false
        );
        document.addEventListener(
            "network_event_received",
            function (param) {
                logIndexConsole("{event_received} Network change occurred!", LOG_MESSAGE_TYPES.event_received);
                function isDisconnected(ipAddress) {
                    return ipAddress === null
                        || ipAddress === "null"
                        || ipAddress === undefined
                        || ipAddress === "undefined"
                        || ipAddress === "0.0.0.0"
                        || (ipAddress.match("^169") !== null);
                }
                function isConnected(ipAddress) {
                    return !isDisconnected(ipAddress);
                }
                hcapPromise.network.getNetworkInformation({
                    "onSuccess" : function(s) {
                        logIndexConsole(localStorage.getItem("tv_ip_address")+" vs "+s.ip_address);
                        if(isConnected(localStorage.getItem("tv_ip_address")) && isDisconnected(s.ip_address)) {
                            //logIndexConsole("logStorage : NETWORK_DISCONNECT");
                            logStorage.sendEvent(logStorage.code.STATUS.NETWORK_DISCONNECT);
                        } else if(isDisconnected(localStorage.getItem("tv_ip_address")) && isConnected(s.ip_address)) {
                            //logIndexConsole("logStorage : NETWORK_CONNECT");
                            logStorage.sendEvent(logStorage.code.STATUS.NETWORK_CONNECT);
                        }

                        logIndexConsole("NEW TV IP: " + s.ip_address);
                        if (s.ip_address == '0.0.0.0') {
                            logIndexConsole("Network is DOWN!", LOG_MESSAGE_TYPES.information);
                            // localStorage.removeItem("access_token");
                            // localStorage.removeItem("refresh_token");
                            localStorage.setItem("tv_ip_address", s.ip_address);
                            localStorage.setItem("pmsStatus","down");
                            logMilestoneEvent('network down');

                            if (IS_MIA_PROJECT) {
                                fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.Network_Down);
                            }

                        }
                        else if ((s.ip_address).match("^169") && COM_TYPE != 'RF') {
                            /* start listener for IP change */
                            logIndexConsole("Network is DOWN!", LOG_MESSAGE_TYPES.information);
                            setTimeout(function(){
                                startNetworkChangeListener();
                            } , 1000 * 5 * 60);
                            localStorage.setItem("pmsStatus","down");
                            logMilestoneEvent('network down');

                            if (IS_MIA_PROJECT) {
                                fDoc.setSystemStatus(fDoc.CONSTANTS.SystemStatus.Network_Down);
                            }
                        }
                        else if(localStorage.getItem("tv_ip_address") != s.ip_address && COM_TYPE != 'RF') {
                            //logIndexConsole("---- ip changed, AutoMapping AGAIN ----- ");
                            logIndexConsole("Network is UP!", LOG_MESSAGE_TYPES.information);

                            startNetworkChangeListener();
                        }
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("getNetworkInfo onFailure : errorMessage = " + f.errorMessage);
                    }
                });
            },
            false
        );

        document.addEventListener(
            "channel_changed",
            function (param) {
                // {Boolean} param.result - true if the current channel is changed successfully, else false.
                // {String} param.errorMessage - in case of failure, this message provides the details.
                logIndexConsole("Event 'channel_changed' is received", LOG_MESSAGE_TYPES.event_received);
                logIndexConsole("Result: " + param.result, LOG_MESSAGE_TYPES.event_received);
                logIndexConsole("Error message: " + param.errorMessage, LOG_MESSAGE_TYPES.event_received);

                // Success Channel Change
                if(param.result) {
                    if(CHANNEL_TYPE === 'RF_DATA') {
                        if (RFVariable.isMuteOn == 1 && PORTAL_ACTIVE) {
                            setTimeout(function() {
                                soundMute();

                            }, 1000);
                            RFVariable.isMuteOn = 0;
                        }

                        hcapPromise.channel.getCurrentChannel({
                            "onSuccess" : function(s) {
                                if (s.channelType == hcap.channel.ChannelType.RF_DATA) {
                                    logIndexConsole("TUNED TO DATA CHANNEL!!!", LOG_MESSAGE_TYPES.event_received);
                                    //logIndexConsole("CALLBACK_ACTIVE: " + CALLBACK_ACTIVE);
                                    //logIndexConsole("CALLBACK_FX_ARRAY.referrer: " + CALLBACK_FX_ARRAY.referrer);

                                    if (CALLBACK_ACTIVE && CALLBACK_FX_ARRAY.referrer != '') {
                                        // logIndexConsole("Found 'callback' in array...");
                                        CALLBACK_FX_ARRAY.callback();

                                        // logIndexConsole("Done executing 'callback' ....");
                                        CALLBACK_ACTIVE = false;

                                        // PLEASE DON'T CHANGE THIS TO TRUE/FALSE, IT CAN HAVE OTHER VALUES - NOT A BOOLEAN
                                        var release_data_channel = localStorage.getItem("release_data_channel");
                                        logIndexConsole("{utilities} release_data_channel = " + release_data_channel);
                                        if(release_data_channel == 'true') {
                                            logIndexConsole("releaseDatachannelForCarousel = true!!!");
                                            localStorage.removeItem("release_data_channel");

                                            setTimeout(function() {
                                                logIndexConsole("About to releaseDatachannelForCarousel from 'channel_changed' event");
                                                releaseDatachannelForCarousel(true);
                                            }, 1500);
                                        }
                                    }
                                }
                                else {
                                    ch = getLogicalChannelInfo(s);
                                    logIndexConsole("{event_received} Tuned to channel " + ch.logicalChannelNumber, LOG_MESSAGE_TYPES.event_received);
                                }
                            },
                            "onFailure" : function(f) {
                                logIndexConsole("FAILURE getCurrentChannel: " + JSON.stringify(f), LOG_MESSAGE_TYPES.error);
                            }
                        });
                    }
                }
            },
            false
        );

        /* LG NLP */
        document.addEventListener(
            "speech_to_text_status_changed",
            function (param) {
                if(VOICE_FOR_STB5500 == true) {
                    // {String} param.status - "processing" : STT is processing. "ready" : STT is completed.
                    // {String} param.resultText - STT result when STT status is changed from "processing" to "ready".
                    logIndexConsole(
                        "Event 'speech_to_text_status_changed' is received.\n" +
                        "intentParam = " + param.intentParam +
                        "status = " + param.status +
                        "text = " + param.resultText
                    );
                    // status = readytext = light_off
                    if(param.status == "ready") {
                        var intent = $.trim(param.resultText);

                        if(iotController.isVoiceIntent(intent) != -1) { //iot control
                            if(_.isObject(iotController) && iotController.initialized){
                                iotController.requestVoiceIntent(intent);
                            };
                        } else if(intent.substring(0, 7) == "channel") {
                            var command = { "value" : "" }
                            if(intent == "channel_up") { // change the channel up and down, go to the channel number.
                                command.value = "up";
                            } else if (intent == "channel_down") {
                                command.value = "down";
                            } else if (intent == "channel_number") {
                                command.value = "number";
                            }

                            if(!PORTAL_ACTIVE) {
                                if(command.value == "number") {
                                    channelChangeFromSpeech(command, param.intentParam);
                                } else {
                                    channelChangeFromSpeech(command);
                                }
                            } else {
                                if(command.value == "number") {
                                    channelChangeAfterHidePortal(command, param.intentParam);
                                } else {
                                    channelChangeAfterHidePortal(command);
                                }
                            }
                        } else if(intent == "id_watch_tv") { // watch TV
                            logIndexConsole("@@@@@@watch TV from speech");
                            watchTVWithSpeech();
                        } else { //page
                            var obj = { "value" : "" };
                            obj.value = getPageFromIntent(intent);
                            logIndexConsole("@@@@@intent page : " + obj.value);
                            if(obj.value !== "" && obj.value != 'none') changePageWithSpeech(obj);
                        }
                    }
                } else {
                    var noticeSpeechEvent = hcap.speech.HostType.TV;
                    // {String} param.status - "processing" : STT is processing. "ready" : STT is completed.
                    // {String} param.actionData - STT intent parameter when STT status is changed from "processing" to "ready".
                    // {String} param.serviceType - STT result category when STT status is changed from "processing" to "ready".
                    // {String} param.actionType - STT result intent when STT status is changed from "processing" to "ready".
                    // {String} param.userUtterance - STT result text when STT status is changed from "processing" to "ready".
                    logIndexConsole(
                        "Event 'speech_to_text_status_changed' is received.\n" +
                        "status = " + param.status +
                        " action data = " + param.actionData +
                        " service type = " + param.serviceType +
                        " action type = " + param.actionType +
                        " user utterance = " + param.userUtterance
                    );
                    // status = readytext = light_off
                    if(param.status == "processing") {
                        var intent = $.trim(param.actionType);

                        if(iotController.isVoiceIntent(intent) != -1) { //iot control
                            if(_.isObject(iotController) && iotController.initialized){
                                iotController.requestVoiceIntent(intent);
                            };
                            noticeSpeechEvent = hcap.speech.HostType.APPLICATION;
                        } else if(intent !== "channel_guide" && intent.substring(0, 7) == "channel") {
                            var command = { "value" : "" }
                            if(intent == "channel_up") { // change the channel up and down, go to the channel number.
                                command.value = "up";
                            } else if (intent == "channel_down") {
                                command.value = "down";
                            } else if (intent == "channel_change") {
                                command.value = "number";
                            }

                            if(!PORTAL_ACTIVE) {
                                if(command.value == "number") {
                                    var actionData = JSON.parse(param.actionData);
                                    logIndexConsole("@@Action data for number: " + actionData['channelNumber']);
                                    channelChangeFromSpeech(command, actionData['channelNumber']);
                                } else {
                                    channelChangeFromSpeech(command);
                                }
                            } else {
                                if(command.value == "number") {
                                    var actionData = JSON.parse(param.actionData);
                                    logIndexConsole("@@Action data for number : " + actionData['channelNumber']);
                                    channelChangeAfterHidePortal(command, actionData['channelNumber']);
                                } else {
                                    channelChangeAfterHidePortal(command);
                                }
                            }
                            noticeSpeechEvent = hcap.speech.HostType.APPLICATION;
                        } else if(intent == "id_watch_tv") { // watch TV
                            logIndexConsole("@@@@@@watch TV from speech");
                            watchTVWithSpeech();
                            noticeSpeechEvent = hcap.speech.HostType.APPLICATION;
                        } else { //page
                            var obj = { "value" : "" };
                            obj.value = getPageFromIntent(intent);
                            logIndexConsole("@@@@@intent page : " + obj.value);
                            if(obj.value !== "" && obj.value != 'none') {
                                changePageWithSpeech(obj);
                                noticeSpeechEvent = hcap.speech.HostType.APPLICATION;
                            }
                        }
                    }
                }

                hcap.speech.decideHost({
                    "serviceType" : param.serviceType,
                    "actionType" : param.actionType,
                    "hostType" : noticeSpeechEvent,
                    "onSuccess" : function() {
                        logIndexConsole("onSuccess");
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    }
                });
            },
            false
        );

        /* IoT */
        document.addEventListener(
            "iot_set_component_result_received",
            function (param) {
                // {Boolean} param.result - true for the success, otherwise false.
                // {String} param.callId - callId of the callId in hcap.iot.requestSetComponent().
                // iotController.publish(param.callId, param.result);
                logIndexConsole(
                    "Event 'iot_set_component_result_received' is received.\n" +
                    "result = " + param.result + "\n" +
                    "callId = " + param.callId
                );
            },
            false
        );

        document.addEventListener(
            "iot_component_reported",
            function (param) {
                // {String} param.thingUid - thing UID.
                // {String} param.componentId - component ID.
                // {Object} param.fromValue - |ComponentValue|, // previous component value of changed
                // {Object} param.toValue - |ComponentValue|, // later component value of changed
                // {Object} |ComponentValue| - json object of a component value
                //     {
                //       "valueType": |string|, // "Unknown", "String", "Boolean", "Variables", "Double", "Float", "Int8", "Int16", "Int32", "Int64", "UInt8", "UInt16", "UInt32", "UInt64"
                //       "value": |string|, // value
                //       "additionalValue": |string|, // custom additional value as a string
                //     }
                logIndexConsole(
                    "Event 'iot_component_reported' is received.\n" +
                    "thingUid = " + param.thingUid + "\n" +
                    "componentId = " + param.componentId + "\n" +
                    "fromValue = " + JSON.stringify(param.fromValue) + "\n" +
                    "toValue = " + JSON.stringify(param.toValue)
                );
                iotController.event("iot_component_reported", param);
            },
            false
        );

        document.addEventListener(
            "volume_level_changed",
            function (param) {
                hcap.volume.getVolumeLevel({
                    "onSuccess" : function(s) {
                        localStorage.setItem("tv_sound", s.level);
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    }
                });
            },
            false
        );

        document.addEventListener(
            "carousel_data_cached",
            function(param) {
                /*
                 {Boolean} param.result - true if a carousel data is cached successfully, else false.
                 {String} param.errorMessage - in case of failure, this message provides the details.
                 {String} param.url - url of the cached carousel data.
                 {String} param.cachePath - path where the carousel data is cached.
                 */

                //logIndexConsole("Result = " + param.result + ", URL = " + param.url);

                if(param.result){
                    logIndexConsole("{event_received} Carousel Data Cached for " + param.url, LOG_MESSAGE_TYPES.event_received);

                    if(param.cachePath.indexOf(".png") > -1){

                        JSON_URL.radar = param.cachePath;
                        setCookie("imagefetchdone", true, COOKIE_EXPIRE_DAYS);
                        var ts = Math.round((new Date()).getTime() / 1000);
                        setCookie("radar_fetch_ts", ts, COOKIE_EXPIRE_DAYS);
                        /*
                        -- REMOVE THIS COMMENT AFTER A MONTH IF NO OBJECTIONS --
                        THIS IS REMOVED TO PREVENT THE updateWidgets FUNCTION FROM BEING CALLED
                        EVERY TIME A SUCCESSFUL CAROUSEL IS PULLED. INSTEAD THE WIDGETS WILL UPDATE
                        WHEN THE DATA CHANNEL IS RELEASED - ONLY ONCE FALL ALL CAROUSEL FILES vs. EVERY TIME FOR EACH CAROUSEL FILE
                        ONLY IN DUAL TUNERS, WE SHOULD CALL THIS, BECAUSE DATA CHANNEL RELEASE ISN'T BEING CALLED
                        */
                        if(CHANNEL_TYPE == 'RF_DATA' && RFVariable.currentPageName == "weather") {
                            if (tunerNum > 1) {
                                checkUpdateWidget('carousel_data_cached radar');
                            }
                            else {
                                var release_data_channel = localStorage.getItem("release_data_channel");
                                var index = window.releaseDataChanelCriteria.indexOf('radar');
                                if (index !== -1) {
                                    logIndexConsole("{utilities} Found 'radar' criteria for window.releaseDataChanelCriteria, removing.");
                                    window.releaseDataChanelCriteria.splice(index, 1);
                                }
                                logIndexConsole("{utilities} window.releaseDataChanelCriteria.length: " + window.releaseDataChanelCriteria.length);
                                if (release_data_channel == "weather" && window.releaseDataChanelCriteria.length == 0) {
                                    localStorage.removeItem("release_data_channel");
                                    setTimeout(function() {
                                        logIndexConsole("{utilities} About to releaseDatachannelForCarousel from 'carousel_data_cached' for accuweather");
                                        releaseDatachannelForCarousel(true);
                                    }, 1500);
                                } else {
                                    logIndexConsole("{utilities} Still waiting for " + JSON.stringify(window.releaseDataChanelCriteria) + " before releaseDatachannelForCarousel");
                                }
                            }
                        }

                        DATAReady.radar = true;
                    }
                    else if(param.cachePath.indexOf("accuweather.json") > -1){
                        JSON_URL.accuweather = param.cachePath;

                        //logIndexConsole("COM_TYPE: " + COM_TYPE);
                        if (COM_TYPE != 'IP') {
                            localStorage.setItem('last_weather_fetch',  moment().unix().toString());
                            setCookie("weatherfetchdone", true, COOKIE_EXPIRE_DAYS);
                        }

                        /*
                        -- REMOVE THIS COMMENT AFTER A MONTH IF NO OBJECTIONS --
                        THIS IS REMOVED TO PREVENT THE updateWidgets FUNCTION FROM BEING CALLED
                        EVERY TIME A SUCCESSFULL CAROUSEL IS PULLED. INSTEAD THE WIDGETS WILL UPDATE
                        WHEN THE DATA CHANNEL IS RELEASED - ONLY ONCE FALL ALL CAROUSEL FILES vs. EVERY TIME FOR EACH CAROUSEL FILE
                        ONLY IN DUAL TUNERS, WE SHOULD CALL THIS, BECAUSE DATA CHANNEL RELEASE ISN'T BEING CALLED
                        */
                        if(CHANNEL_TYPE == 'RF_DATA' && RFVariable.currentPageName == "weather") {
                            if (tunerNum > 1) {
                                checkUpdateWidget('carousel_data_cached weather');
                            }
                            else {
                                var release_data_channel = localStorage.getItem("release_data_channel");
                                var index = window.releaseDataChanelCriteria.indexOf('accuweather');
                                if (index !== -1) {
                                    logIndexConsole("{utilities} Found 'accuweather' criteria for window.releaseDataChanelCriteria, removing.");
                                    logIndexConsole("{utilities} release_data_channel: " + release_data_channel);
                                    window.releaseDataChanelCriteria.splice(index, 1);
                                }
                                logIndexConsole("{utilities} window.releaseDataChanelCriteria.length: " + window.releaseDataChanelCriteria.length);
                                if (release_data_channel == "weather" && window.releaseDataChanelCriteria.length == 0) {
                                    localStorage.removeItem("release_data_channel");
                                    setTimeout(function() {
                                        logIndexConsole("{utilities} About to releaseDatachannelForCarousel from 'carousel_data_cached' for accuweather");
                                        releaseDatachannelForCarousel(true);
                                    }, 1500);
                                } else {
                                    logIndexConsole("{utilities} Still waiting for " + JSON.stringify(window.releaseDataChanelCriteria) + " before releaseDatachannelForCarousel");
                                }
                            }
                        }
                        setCookie("weatherfetchdone", true, COOKIE_EXPIRE_DAYS);
                        DATAReady.accuweather = true;
                    }
                    else if(param.cachePath.indexOf("tvpms.json") > -1){

                        JSON_URL.tvpms = param.cachePath;
                        setCookie("pmsfetchdone", true, 1);

                        loadJSON(getTvpmsGuestData, CACHE_PATH + "tvpms.json");

                        if(!UrlExists(CACHE_PATH + "tvpms.json")==200) {
                            /* logIndexConsole("### tvpms.json not found on carousel!"); */
                        }
                        if(CHANNEL_TYPE == 'IP_DATA') {
                            setTimeout(function () {
                                getCarousel(CARAUSEL_PATH + 'tvpms.json');
                            }, 120000);
                        }
                        /*
                        -- REMOVE THIS COMMENT AFTER A MONTH IF NO OBJECTIONS --
                        THIS IS REMOVED TO PREVENT THE updateWidgets FUNCTION FROM BEING CALLED
                        EVERY TIME A SUCCESSFULL CAROUSEL IS PULLED. INSTEAD THE WIDGETS WILL UPDATE
                        WHEN THE DATA CHANNEL IS RELEASED - ONLY ONCE FALL ALL CAROUSEL FILES vs. EVERY TIME FOR EACH CAROUSEL FILE
                        ONLY IN DUAL TUNERS, WE SHOULD CALL THIS, BECAUSE DATA CHANNEL RELEASE ISN'T BEING CALLED
                        */
                        else {
                            if(CHANNEL_TYPE == 'RF_DATA' && RFVariable.currentPageName == "billing" && tunerNum > 1) {
                                checkUpdateWidget('carousel_data_cached tvpms');
                            }
                        }
                        DATAReady.tvpms = true;
                    }
                    else if(param.cachePath.indexOf("event_data.json") > -1){
                        DATAReady.event_data = false;
                        JSON_URL.event_data = param.cachePath;
                        setCookie("epgfetchdone", true, COOKIE_EXPIRE_DAYS);
                        expireCookie("fetching_fresh_epg_data");
                        expireCookie("epgfailed");
                        loadJSON(loadEventData, CACHE_PATH +  "event_data.json");
                    }
                    else if (param.cachePath.indexOf("tvpms.guest.json") > -1) {
                        /*
                         logIndexConsole("### addEventListener - param.cachePath.indexOf(tvpms.guest.json) > -1 ");
                         changed to patch tvpms.json instead of tvpms.guest.json
                         loadJSON(getTvpmsGuestData, CACHE_PATH + "tvpms.guest.json");
                         */
                        setCookie("pmsguestfetchdone", true, 1);

                        if(CHANNEL_TYPE == 'IP_DATA') {
                            setTimeout(function () {
                                getCarousel(CARAUSEL_PATH + 'tvpms.guest.json');
                            }, 120000);
                        }
                    }
                    else if(param.cachePath.indexOf("addChannels.json") > -1) {  //pay channel for RF
                        loadJSON(function(data){
                            var list = _.reject(data, function(paychannel){  //remove paychannel
                                var result = false;

                                if(paychannel.roomId != getCookie("roomnumber")) {
                                    result = true;
                                }
                                if(moment(paychannel.expireDate).diff(moment()) < 1000 ) {  //expired paid channel
                                    result = true;
                                }

                                return result;
                            });
                            if(!_.isEqual(list, JSON.parse(localStorage.getItem("paidChannellist")))) setPaidChannelList(list);
                        },  CACHE_PATH +"addChannels.json");

                        setTimeout(function() {
                            releaseDatachannelForCarousel(true);
                        }, 1500);
                    }
                    else if(param.cachePath.indexOf("customApps.json") > -1) {
                        if (COM_TYPE != 'IP') {
                            setCookie("customappsfetchdone", true, COOKIE_EXPIRE_DAYS);
                        }
                    } 
                    else if(param.cachePath.indexOf("uiConfig.json") > -1) {
                        if (COM_TYPE != 'IP') {
                            setCookie("appconfigfetchdone", true, COOKIE_EXPIRE_DAYS);
                        }
                    }

                    // Used in DEBUG page
                    localStorage.setItem("DATAReady", JSON.stringify(DATAReady));

                    if (IS_MIA_PROJECT) {
                        verifySystemReady();
                    }
                    /*
                    ONLY EXECUTE ONCE PER BOOTUP SEQUENCE AND NOT EVERY TIME A CAROUSEL FILE IS FETCHED.
                    */
                    else if (getCookie("fetchcomplete") == '') {
                        if (DATAReady.accuweather && DATAReady.radar && DATAReady.tvpms && DATAReady.event_data && DATAReady.uiConfig && (DATAReady.channels || DATAReady.groups)) {

                            if (CHANNEL_TYPE == 'RF_DATA') {
                                logIndexConsole("NON-MIA BOOTUP SEQUENCE FOR ROOM NUMBER " + getRoomNumber()
                                    + ", WITH XAIT " + currentXAIT + " IS COMPLETE!", LOG_MESSAGE_TYPES.milestone_completed);

                                if (RFChangeChannelTimeOut != "undefined") {
                                    clearTimeout(RFChangeChannelTimeOut);
                                }

                                if (RFVariable.TV_MODE !== hcap.power.PowerMode.WARM && GLOBAL_SOUND_SETTING != 2) {
                                    var channel = getCookie('current_channel');
                                    if (RFVariable.currentPageName === "weather" || RFVariable.currentPageName === "billing") {
                                        logIndexConsole("***@@@this is weather or billing page!!!");
                                        if (GLOBAL_SOUND_SETTING == 1) {
                                            if (getCookie("imagefetchdone") == 'true' && getCookie("weatherfetchdone") == 'true') {
                                                releaseDatachannelForCarousel(true);
                                            } else if (RFVariable.currentPageName === "billing" && (getCookie("pmsfetchdone") == 'true')) {
                                                releaseDatachannelForCarousel(true);
                                            }
                                        }
                                    } else if (typeof channel === "undefined" && fDoc.document.getElementById('lg_video') === null) {
                                        setTimeout(function () {
                                            tuneToStartChannel();
                                        }, 1000);
                                    } else {
                                        if (fDoc.document.getElementById('lg_video') !== null) {
                                            RFVariable.videoWidgetInPortal = 1;
                                            fDoc.updateWidgets('checkDataReady - CASE 3');
                                        } else {
                                            var physical_channel = getPhysicalChannelInfo(channel);
                                            if (physical_channel != null) {
                                                setTimeout(function () {
                                                    changeChannel(physical_channel, 0, 0, 'index.html - DATAREADY', null);
                                                }, 1000);
                                            }
                                        }
                                    }
                                }
                            }

                            setCookie("fetchcomplete", true, COOKIE_EXPIRE_DAYS);
                            trimApplicationMilestoneHistory();
                        }
                    }
                }
                else {
                    logIndexConsole("{event_received} Carousel Data failed to cache for " + param.url, LOG_MESSAGE_TYPES.error);
                    if (param.cachePath.indexOf("oneClickService.json") == -1){
                        hcap.power.getPowerMode({
                            "onSuccess" : function(s) {

                                if (s.mode == hcap.power.PowerMode.WARM || CHANNEL_TYPE == "IP_DATA") {
                                    if(CHANNEL_TYPE == "IP_DATA"){
                                        setTimeout(function() {
                                            getCarousel(param.url);
                                        }, 10000);
                                    }
                                }
                                else {
                                    if(param.cachePath.indexOf("tvpms.json") > -1) {
                                        logIndexConsole("{data} Carousel Failure of tvpms.json: " + CarouselAttemptCount.tvpms);
                                        // Bugfix (by suntaek) - prevent from limitless fn call (getCarousel) when fails
                                        if (CarouselAttemptCount.tvpms >= 5) {
                                            if(UrlExists(CACHE_PATH + "tvpms.json")==200){
                                                //logIndexConsole("tvpms.json exists on carousel!");
                                                loadJSON(getTvpmsGuestData, CACHE_PATH + "tvpms.json");
                                            }
                                            else{
                                                logIndexConsole("loading local version of tvpms.json...");
                                                loadJSON(getTvpmsGuestData, "tvpms.json");
                                            }
                                        }
                                        else{
                                            CarouselAttemptCount.tvpms++;
                                            getCarousel(param.url);
                                        }
                                    }
                                    else if(param.cachePath.indexOf("event_data.json") > -1) {
                                        logIndexConsole('{data} Carousel Failure of event_data.json: ' + CarouselAttemptCount.event_data);
                                        if (CarouselAttemptCount.event_data > 3) {
                                            setCookie("epgfailed", "true", 1);

                                            if (getCookie("fetching_fresh_epg_data") != '') {
                                                expireCookie("fetching_fresh_epg_data");
                                                if(window.parent.GLOBAL_SOUND_SETTING == 2) {
                                                    releaseDatachannelForCarousel(false);
                                                } else {
                                                    releaseDatachannelForCarousel(true);
                                                }
                                            }

                                            if (UrlExists(CACHE_PATH + "event_data.json") == 200) {
                                                loadJSON(loadEventData, CACHE_PATH + "event_data.json");
                                            }
                                            else if (UrlExists("event_data.json") == 200) {
                                                logIndexConsole("{data} Unable to access 'event_data.json' in " + CACHE_PATH + ", loading local version");
                                                loadJSON(loadEventData, "event_data.json");
                                            }
                                            else {
                                                logIndexConsole("{data} Unable to find EPG data on the carousel or locally!");
                                                expireCookie("fetching_fresh_epg_data");
                                                checkDataReady();
                                            }
                                        }
                                        else {
                                            setTimeout(function () {
                                                CarouselAttemptCount.event_data++;
                                                setCookie("fetching_fresh_epg_data", true);
                                                getCarousel(param.url);
                                            }, 500);
                                        }
                                    }
                                }
                            },
                            "onFailure" : function(f) {
                                logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                            }
                        });

                        if (CHANNEL_TYPE == 'RF_DATA' && GLOBAL_SOUND_SETTING == 1) {
                            if(RFVariable.currentPageName === "weather" || RFVariable.currentPageName === "billing") {
                                if(getCookie("imagefetchdone") == 'true' && getCookie("weatherfetchdone") == 'true') {
                                    //releaseDatachannelForCarousel(true);
                                } else if(RFVariable.currentPageName === "billing" && (getCookie("pmsfetchdone") == 'true')) {
                                    releaseDatachannelForCarousel(true);
                                }
                            }
                        }

                        if(CHANNEL_TYPE == 'RF_DATA' && param.cachePath.indexOf("addChannels.json") > -1) {
                            if(PORTAL_ACTIVE && uiConfigUseGroups && COM_TYPE == "RF" && getCookie("isPmsActive") === "true") {
                                fetchPayChannel();

                                setTimeout(function() {
                                    releaseDatachannelForCarousel(true);
                                }, 1500);
                            }
                        }

                        localStorage.setItem("allowHide", true);
                        localStorage.setItem("keyAllowed", true);
                    }
                }
            },
            false
        );

        document.addEventListener(
            "power_mode_changed",
            function (param) {
                logIndexConsole("{utilities} Event 'power_mode_changed' received!", LOG_MESSAGE_TYPES.event_received);
                var fDoc = getIframeObject();
                if(PORTAL_ACTIVE) {
                    //prevent appearing start channel in video widget when loading the app.
                    if(fDoc.document.getElementById('lg_video') !== null) {
                        fDoc.document.getElementById('lg_video').style.backgroundImage = "none";
                        if(GLOBAL_SOUND_SETTING == 2) {
                            controlBgm(1);
                        } else if (GLOBAL_SOUND_SETTING == 0) {
                            soundMute();
                        }
                    }
                }

                //prevent appearing start channel in page.
                if (!IS_MIA_PROJECT && !isEditorMode() && !isPreviewMode()) {
                    $('body').css('background-color', 'black');
                } else {
                    fetchRoomStatus();
                }

                hcap.power.getPowerMode({
                    "onSuccess" : function(s) {
                        var normal_mode_dont_reboot = localStorage.getItem("normal_mode_dont_reboot");
                        var running_clear_credentials = localStorage.getItem("running_clear_credentials");
                        fDoc = getIframeObject();
                        var mia_powerMode = (IS_MIA_PROJECT ? fDoc.CONSTANTS.PowerMode.OFF : null);
                        //logIndexConsole("normal_mode_dont_reboot: " + normal_mode_dont_reboot);
                        //logIndexConsole("running_clear_credentials: " + running_clear_credentials);

                        if(s.mode === hcap.power.PowerMode.NORMAL) {
                            logIndexConsole("{power_mode} TV is ON", LOG_MESSAGE_TYPES.event_received);
                            logStorage.sendEvent(logStorage.code.STATUS.POWER_AWAKE);

                            if (IS_MIA_PROJECT) {
                                mia_powerMode = fDoc.CONSTANTS.PowerMode.ON;
                                if (typeof normal_mode_dont_reboot == "undefined" || normal_mode_dont_reboot == "" || normal_mode_dont_reboot == null) {
                                    localStorage.removeItem("TurnTvOnAfterReboot");
                                }

                                if (running_clear_credentials == null) {
                                    logIndexConsole("{power_mode} ISSUING 'mode_changed : power' event");
                                    fDoc.dispatchNewEvent('mode_changed', 'power', {value: mia_powerMode});
                                }
                            }
                            else {
                                // Skip sound setting for MIA
                                setTimeout(function() {
                                    if (PORTAL_ACTIVE && !getCookie("smartapp_freezetimer")) {
                                        if(IS_TV_WIDGET_IN_PORTAL == 'N') {
                                            if(GLOBAL_SOUND_SETTING == 2) {
                                                controlBgm(1);
                                            } else if(GLOBAL_SOUND_SETTING == 0) {
                                                soundMute();
                                            }
                                        }
                                        if (GLOBAL_SOUND_SETTING != 0) {
                                            if (localStorage.getItem('isAdvanced') != null && localStorage.getItem('isAdvanced') == 'true') {
                                                hcap.time.getAlarmInformation({
                                                    'onSuccess' : function(s) {
                                                        if (s.hour != -1) {
                                                            setTvSetupVolume();
                                                        }
                                                    },
                                                    'onFailure' : function(f) {
                                                        logIndexConsole('{power_mode} error: ' + f.errorMessage);
                                                        setTvSetupVolume();
                                                    }
                                                });
                                            }
                                            else {
                                                setTvSetupVolume();
                                            }
                                        }
                                    }
                                }, 500);

                                if(VOICE_FOR_STB5500 == true) {
                                    hcap.property.setProperty({
                                        "key":"speech_recognition",
                                        "value":"1",
                                        "onSuccess":function() {
                                            //logIndexConsole("speech recognition : MIC on - success");
                                        },
                                        "onFailure":function(f) {
                                            logIndexConsole("{power_mode} speech recognition : MIC on - fail");
                                        }
                                    });
                                }

                                if (typeof normal_mode_dont_reboot == "undefined" || normal_mode_dont_reboot == "" || normal_mode_dont_reboot == null) {
                                    if (typeof running_clear_credentials == 'undefined' || running_clear_credentials == null) {
                                        if (!getCookie("smartapp_freezetimer")){
                                            SetPortalStatus(SHOW_PORTAL);
                                            if(getCookie("pmsType") == "LEGACY") {
                                                displayWelcomeMessage(getCookie("tvpmsguest"));
                                            }
                                            else {
                                                goHomePro();
                                            }
                                        }
                                    }
                                    else {
                                        SetPortalStatus(SHOW_PORTAL);
                                        goHomePro();
                                    }

                                    TurnTvOnAfterReboot = localStorage.getItem("TurnTvOnAfterReboot");
                                    localStorage.removeItem("TurnTvOnAfterReboot");

                                    // If flag is not set, then normal power on
                                    if (TurnTvOnAfterReboot == '' || TurnTvOnAfterReboot == null) {
                                        if(getCookie("fetchcomplete") != "") {
                                            tuneToStartChannel();
                                        }
                                    }

                                    if(CHANNEL_TYPE === 'RF_DATA') {
                                        RFVariable.TV_MODE = hcap.power.PowerMode.NORMAL;

                                        if(fDoc.document.getElementById('lg_video') !== null) {
                                            RFVariable.videoWidgetInPortal = 1;
                                            fDoc.updateWidgets();
                                        }
                                        else {
                                            if(GLOBAL_SOUND_SETTING != 2) {
                                                tuneToStartChannel();
                                            }
                                        }

                                        if(typeof RFVariable.pmsUpdateWARMmodeTimer !== 'undefined') {
                                            logIndexConsole("***@@@Clear Warm mode Timer!!!");
                                            clearTimeout(RFVariable.pmsUpdateWARMmodeTimer);
                                        }
                                    }
                                }
                                else {
                                    if(GLOBAL_SOUND_SETTING != 2 && fDoc.document.getElementById('lg_video') === null) {
                                        tuneToStartChannel();
                                    }
                                }
                            }
                            // check memory usage (catch-all)
                            handle_Memory_Usage();
                        }
                        else if (s.mode === hcap.power.PowerMode.WARM) {
                            logIndexConsole("{power_mode} TV is OFF",  LOG_MESSAGE_TYPES.event_received);
                            logStorage.sendEvent(logStorage.code.STATUS.POWER_WARM);

                            if(!_.isEmpty(getCookie('previous_channel')) && !_.isUndefined(getCookie('previous_channel')) && getCookie('previous_channel') > -1) {
                                var prevChannel = parseInt(getCookie('previous_channel'));

                                if(prevChannel > -1){

                                    current_channel = prevChannel;
                                    setCookie('current_channel', current_channel, COOKIE_EXPIRE_DAYS);
                                    var physical_channel = getPhysicalChannelInfo(current_channel);
                                    if (!_.isUndefined(physical_channel) && !_.isEmpty(physical_channel)){
                                        if(localStorage.getItem("Launching_SmartApp") == "true") {
                                            logIndexConsole("{utilities} Nothing To Do - channel tuning!!!");
                                        } else {
                                            changeChannel(physical_channel, 0, 0, window.POWER_MODE_CHANNEL_CHANGE_REFERRER, null);
                                        }
                                    } else{
                                        logIndexConsole("Unable to find physical channel info for " + current_channel);
                                    }
                                }
                            }

                            if (IS_MIA_PROJECT) {
                                mia_powerMode = fDoc.CONSTANTS.PowerMode.OFF;

                                if (running_clear_credentials == null) {
                                    logIndexConsole("{power_mode} ISSUING 'mode_changed : power' event");
                                    fDoc.dispatchNewEvent('mode_changed', 'power', {value: mia_powerMode});
                                }
                            }
                            else {
                                var tmpFX = function() {
                                    if(PORTAL_ACTIVE && parent.GLOBAL_SOUND_SETTING == 2) {
                                        parent.controlBgm(0);
                                    }
                                };

                                if(isVODPlaying()) {
                                    fDoc.exitVOD(tmpFX());
                                }
                                else {
                                    tmpFX();
                                }
                                logIndexConsole("{utilities} Sending Logs to ES");
                                logStorage.sendLogsToServer().catch(function(){logIndexConsole("Failed Sending Logs to ES");});
                                var temp_current = getCookie("current_channel");
                                setCookie("last_channel", temp_current, COOKIE_EXPIRE_DAYS);

                                tmp = getCookie("startChannelLogicalNumber");
                                if( startChannelActive == false && getCookie("last_channel") != "") {
                                    logIndexConsole("{bootup} Changing current_channel to " + getCookie("last_channel"));
                                    tmp = getCookie("last_channel");
                                }
                                setCookie("current_channel", tmp, COOKIE_EXPIRE_DAYS);

                                if( _.isEmpty(getCookie('previous_channel')) || _.isUndefined(getCookie('previous_channel')) ){
                                    setCookie('previous_channel', -1, COOKIE_EXPIRE_DAYS);
                                }

                                if ("RF_DATA" == CHANNEL_TYPE) {
                                    RFVariable.TV_MODE = hcap.power.PowerMode.WARM;
                                }
                            }
                            // check memory usage (catch-all)
                            handle_Memory_Usage();
                            if (AutoMapNumAttempsExceeded) {
                                autoMapSequence();
                            }
                        }
                        // SHOULD NEVER FALL HERE
                        else {
                            logIndexConsole("{power_mode} mode: SOMETHING ELSE", LOG_MESSAGE_TYPES.event_received);

                            if(GLOBAL_SOUND_SETTING == 2) {
                                controlBgm(0);
                            }
                        }
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    }
                });
            },
            false
        );

        document.addEventListener(
            "hcap_application_focus_changed",
            function (param) {
                var fDoc = getIframeObject();
                logIndexConsole("{event_received} Application Focus Changed",  LOG_MESSAGE_TYPES.event_received);
                if(param.eventType == "focused"){

                    if(getCookie("hcap_focused") == 0) {

                        setCookie("hcap_focused", "1", COOKIE_EXPIRE_DAYS);
                        if(PORTAL_ACTIVE && !IS_MIA_PROJECT) {
                            if((getCookie("guide_to_page") == 0 && getCookie("guide_to_channel") == 0)
                                || (_.isNull(fDoc.document.getElementById('lg_video')) && _.isNull(fDoc.document.getElementById('pip')))){
                                //logIndexConsole("hcap_application_focus_changed: reload Page");
                                localStorage.setItem('MEDIA_START_UP', 0);

                                var isCallBySmartApps = localStorage.getItem("SMARTAPP");
                                if(isCallBySmartApps !== null && isCallBySmartApps === "ON") {
                                    localStorage.removeItem("SMARTAPP");

                                    setTimeout(function() {
                                        fDoc.goto(fDoc.window.currentPage);
                                    }, 1000);
                                } else {
                                    var isNotReload = localStorage.getItem("changed_from_voice");
                                    if(typeof isNotReload != 'undefined' && isNotReload == 'true') {
                                        localStorage.removeItem("changed_from_voice");
                                    } else {
                                        if(!_.isNull(localStorage.getItem("active_smartapp_id"))) {
                                            if( GLOBAL_SOUND_SETTING == 0 && (isCallBySmartApps == "BY_BUTTON" || isCallBySmartApps == "HOTKEY")) {
                                                if(fDoc.document.getElementById('lg_video') == null && fDoc.document.getElementById('pip') == null) {
                                                    soundMute();
                                                }
                                                localStorage.removeItem("SMARTAPP");
                                            } else if(GLOBAL_SOUND_SETTING == 2 && (isCallBySmartApps == "BY_BUTTON" || isCallBySmartApps == "HOTKEY")) {
                                                controlBgm(1);
                                                localStorage.removeItem("SMARTAPP");
                                            }
                                            setTimeout(function() {
                                                if(getIframeObject().$('.smartapps_v2').length > 0 && PORTAL_ACTIVE ) {
                                                    fDoc.goto(fDoc.window.currentPage);
                                                }
                                            }, 1000);
                                        } else {
                                            fDoc.goto(fDoc.window.currentPage);
                                        }
                                    }
                                }
                            }

                        }


                        hcap.volume.getVolumeLevel({
                            "onSuccess" : function(s) {
                                localStorage.setItem("tv_sound", s.level);
                            },
                            "onFailure" : function(f) {
                                logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                            }
                        });

                        if(fDoc) {
                            //logIndexConsole("hcap_application_focus_changed: restarting timer");
                            if(typeof fDoc.pageResetTimer === "function") {
                                /* channelbanner.html don't have pageResetTimer */
                                fDoc.pageResetTimer();
                            } else if(typeof fDoc.resetTimer === "function") {
                                fDoc.resetTimer();
                            }

                            /*  logIndexConsole("About to goToDetermineTVSound....");
                             if(typeof fDoc.goToDetermineTVSound === "function") {
                             fDoc.goToDetermineTVSound();
                             } */
                        }
                        else {
                            logIndexConsole("Unable to find iframe");
                        }

                        active_smartapp_id = localStorage.getItem("active_smartapp_id");
                        logIndexConsole("{utilities} Clearing active_smartapp_id: " + active_smartapp_id);

                        if (typeof active_smartapp_id === 'string' && active_smartapp_id != '') {
                            localStorage.removeItem("active_smartapp_id");
                            //logIndexConsole("update OTT Log");
                            var selectedApp = _.find(JSON.parse(localStorage.getItem("customApps") || "[]"), function(v,k){return v.app_id===active_smartapp_id});
                            var selectedAppName = selectedApp ? selectedApp.name : "null";
                            expireCookie("smartapp_freezetimer");

                            if (active_smartapp_id !== "244115188075859013") {
                                hcap.preloadedApplication.destroyPreloadedApplication({
                                    "id" : active_smartapp_id,
                                    "onSuccess" : function() {
                                        logIndexConsole("Sucessfully destroyed appid: " + active_smartapp_id);
                                    },
                                    "onFailure" : function(f) {
                                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                                    }
                                });
                            }
                        } else {
                            if(!PORTAL_ACTIVE && !isVODPlaying()) {
                                hcap.channel.getCurrentChannel({
                                    "onSuccess" : function(s) {
                                        var ch = getLogicalChannelInfo(s);

                                        if(ch.hasOwnProperty("logicalChannelNumber")) {
                                            var current_channel = ch.logicalChannelNumber;
                                            setCookie("current_channel", current_channel, COOKIE_EXPIRE_DAYS);
                                            var url = "channelbanner.html?mode=tv&chNum=" + current_channel;
                                            document.getElementById('iframe_id').setAttribute('src', url);
                                        }
                                    },
                                    "onFailure" : function(f) {
                                        logIndexConsole("FAILURE in getCurrentConfigChannel!");
                                    }
                                });
                            }
                        }
                    }
                }
                else{
                    if(getCookie("hcap_focused") == 1) {
                        setCookie("hcap_focused", "0", COOKIE_EXPIRE_DAYS);
                        if(PORTAL_ACTIVE) {
                            if(GLOBAL_SOUND_SETTING == 2) {
                                //logIndexConsole("hcap_application_unfocus_changed: stop BGM");
                                controlBgm(0);
                            } else if (GLOBAL_SOUND_SETTING == 0) {
                                //logIndexConsole("hcap_application_unfocus_changed: sound On");
                                soundOn();
                            }
                        }

                        //logIndexConsole("hcap_application_focus_changed: clearing timer");
                        if (typeof fDoc.clearTimer === 'function') {
                            fDoc.clearTimer();
                        }
                    }
                }
            },
            false
        );

        // FOR MIA PROJECTS, OVERRIDE LISTENER TO HANDLER
        if (!IS_MIA_PROJECT) {
            document.addEventListener(
                "media_event_received",
                function (param) {
                    logIndexConsole("{event_received} Media Event '" + param.eventType + "'", LOG_MESSAGE_TYPES.event_received);
                    var fDoc = getIframeObject();

                    switch(param.eventType) {
                        case "play_end":
                            logIndexConsole("{event_received} Reached end of media");

                            fDoc.exitVOD(function() {
                                //logIndexConsole("{exitVOD} callback function started", LOG_MESSAGE_TYPES.information);
                                fDoc.goToReferrerPage(true);
                            }, window.currentPage, null);
                            break;
                        case "play_start":
                            if(!isEditorMode() && !isPreviewMode()) {
                                soundOn();
                                fDoc.setBackgroundToTV();
                            }
                            break;
                    }
                },
                false
            );
        }
        // MIA PROJECT (SET HCAP MODE)
        else {
            hcap.mode.setHcapMode({
                "mode" : hcap.mode.HCAP_MODE_1,
                "onSuccess" : function() {
                    //logIndexConsole("onSuccess: hcap.mode.HCAP_MODE_1");
                },
                "onFailure" : function(f) {
                    logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                }
            });
        }
        /***************** END GLOBAL LISTENERS **********/

        function performAdminAction(action) {
            logIndexConsole("{admin} action: " + action);
            switch(action) {
                case "reload_iframe":
                    fDoc.location.reload();
                    break;
                case "reload_wrapper":
                    window.location.reload();
                    break;
                case "goto_portal":
                    fDoc.location.href  = "portal.html";
                    break;
                case "goto_stats":
                    fDoc.location.href  = "stats.html";
                    break;
                case "goto_mia_demo":
                    fDoc.location.href  = "debug.html";
                    break;
                case "reboot":
                    reboot();
                    break;
            }
            $("#admin_menu_content").hide();
            adminMenuState = 'off';
        }

        function setByTvSetup() {
            setTvSettingsLock();
            setInstalltionMenuPassword();
        }

        function setTvSettingsLock() {
            if (_.has(tv_setup, 'tv_settings_lock') && tv_setup.tv_settings_lock.value != undefined) {
                var settingData = 'on';
                if (tv_setup.tv_settings_lock.value == 'on') {
                    settingData = 'off';
                }

                hcap.property.getHotelMode({
                    "onSuccess" : function(s) {
                        logIndexConsole("onSuccess : getHotelMode = " + s.hotelMode);
                        var hotelModeParam = JSON.parse(s.hotelMode);

                        if (settingData == 'off') {
                            hotelModeParam.enable = "on";
                            hotelModeParam.settings.limitedMode.enable = "on";
                        }

                        if (hotelModeParam.enable === "on" && hotelModeParam.settings.limitedMode.enable === "on") {
                            hotelModeParam.settings.limitedMode.settings.menuDisplay = settingData;
                            hcap.property.setHotelMode({
                                "hotelModeLength" : 4096, /* hotelModeLength (any number) param is needed. Confirmed by AFT */
                                "hotelMode" : JSON.stringify(hotelModeParam),
                                "onSuccess" : function() {
                                    logIndexConsole("onSuccess : setHotelMode");
                                },
                                "onFailure" : function(f) {
                                    logIndexConsole("onFailure setHotelMode : errorMessage = " + f.errorMessage);
                                }
                            });
                        }
                    },
                    "onFailure" : function(f) {
                        logIndexConsole("onFailure : errorMessage = " + f.errorMessage);
                    }
                });
            }
        }

        function setInstalltionMenuPassword() {
            if (_.has(tv_setup, 'installation_menu_password') && tv_setup.installation_menu_password.value != undefined) {
            var password = tv_setup.installation_menu_password.value;
                if (!_.isUndefined(password) && !_.isEmpty(password)) {
                    var settingData = tv_setup.installation_menu_password.value;

                    hcap.property.setProperty({
                        "key": "installation_menu_password",
                        "value": settingData,
                        "onSuccess": function (s) {
                            logIndexConsole("{bootup} Successfully set installation menu password to " + settingData);
                        },
                        "onFailure": function(e){
                            logIndexConsole('{bootup} Unable to set installation menu password ' + e.errorMessage);
                        }
                    });
                }
            }
        }

        function getRoomNumber() {
            var roomnumber = getCookie("roomnumber");
            var tvID = getCookie("tvID");
            if (roomnumber) {
                return roomnumber;
            } else if (tvID) {
                return tvID;
            }
            return "Unknown Room";
        }

        function setDebugPanelState(override) {
            $("#debugging_panel").hide();
            $("#page_debugging_panel").hide();

            var indexDebugOn = isDebugOn("index");
            var portalDebugOn = isDebugOn("portal");

            if (indexDebugOn || portalDebugOn || override) {
                var debugRoomId = "all";

                logIndexConsole("{bootup} debugRoomId: " + debugRoomId);
                if (typeof debugRoomId !== 'undefined' || override) {
                    if (debugRoomId == localStorage.getItem("room_number") || debugRoomId == "all" || override) {
                        logIndexConsole("{bootup} Mached criteria for debug panel!", LOG_MESSAGE_TYPES.milestone_completed);

                        if (indexDebugOn) {
                            if (isBrowserDebugAllowed()) {
                                hcapPromise.system.getBrowserDebugMode()
                                    .then(function (response) {
                                        if (response.debugMode) {
                                            logIndexConsole("Browser Debug is already ENABLED [" + response.debugMode + "] - Do nothing", LOG_MESSAGE_TYPES.information);
                                        } else {
                                            setBrowserDebugMode(true);
                                        }
                                    })
                                    .catch(function(error) {
                                        logIndexConsole("{bootup} Failed to get debug inspector: " + JSON.stringify(error), LOG_MESSAGE_TYPES.error);
                                    });
                            }

                            $("#debugging_panel").show();
                            $("#page_debugging_panel").show();

                            var menuItems = Array();
                            menuItems.push({'key': 'reload_iframe', 'value': 'Reload PST'});
                            menuItems.push({'key': 'reload_wrapper', 'value': 'Reload Wrapper'});
                            menuItems.push({'key': 'goto_portal', 'value': 'Go to Portal'});
                            menuItems.push({'key': 'goto_stats', 'value': 'Go to Stats'});

                            if (IS_MIA_PROJECT) {
                                $("#stats_button").hide();
                                $("#demo_button").show();
                                menuItems.push({'key': 'goto_mia_demo', 'value': 'Go to MIA Demo'});
                            } else {
                                $("#stats_button").show();
                                $("#demo_button").hide();
                            }

                            menuItems.push({'key': 'reboot', 'value': 'Reboot'});

                            var admin_menu_content = $("#admin_menu_content");
                            var html = "";
                            $.each(menuItems, function (key, item) {
                                html = html + '<a class="admin_menu_item" action="' + item.key + '">' + item.value + '</a>';
                            });
                            admin_menu_content.html(html);

                            $("#admin_menu_btn").on('click', function () {
                                if (adminMenuState === 'off') {
                                    $("#admin_menu_content").show();
                                    adminMenuState = 'on';

                                    setTimeout(function () {
                                        $("#admin_menu_content").hide();
                                        adminMenuState = 'off';
                                    }, 5000);
                                } else if (adminMenuState === 'on') {
                                    $("#admin_menu_content").hide();
                                    adminMenuState = 'off';
                                }
                            });

                            $(".admin_menu_item").click(function () {
                                var action = $(this).attr("action");
                                logIndexConsole("Clicked action '" + action + "'");
                                performAdminAction(action);
                            });
                        } else if (portalDebugOn) {
                            $("#page_debugging_panel").show();
                        }
                    }
                }
            } else {
                var enabledBrowserDebugByKeyCombo = localStorage.getItem("ENABLE_INSPECTOR");
                if (isBrowserDebugAllowed() && !enabledBrowserDebugByKeyCombo) {
                    hcapPromise.system.getBrowserDebugMode()
                        .then(function (response) {
                            if (!response.debugMode) {
                                logIndexConsole("Browser Debug is already DISABLED - Do nothing", LOG_MESSAGE_TYPES.information);
                            } else {
                                setBrowserDebugMode(false);
                            }
                        })
                        .catch(function(error) {
                            logIndexConsole("{bootup} Failed to get debug inspector: " + JSON.stringify(error), LOG_MESSAGE_TYPES.error);
                        });
                }
            }
        }

        function toggleConsole(forceOn) {
            if (forceOn) {
                $('.index_console').removeClass('hidden');
            } else {
                $('.index_console').toggleClass('hidden');
            }
        }

        function clearIndexConsole() {
            $('.index_console').html("");
        }

    </script>
</head>

<body style="margin: 0px; background-color: black">

<div id="debugging_panel" style="display: none; position: absolute; top: 10px; left:10px; width: 48%; font-size:11px;">
    <span id="admin_menu_btn">-- Select Action --</span>
    <button type="button" id="button2" onclick="toggleConsole(null)">Toggle Console</button>
    <button type="button" id="button6" onclick="clearIndexConsole();">Clear Console</button>
    <button type="button" id="button3" onclick="scrollConsole('index_console','top');">Top</button>
    <button type="button" id="button4" onclick="scrollConsole('index_console','up');">-</button>
    <button type="button" id="button5" onclick="scrollConsole('index_console','down');">+</button>
    <input type="checkbox" id="auto_scroll" value="on" checked="checked" onclick="toggleAutoScroll();"> Auto-Scroll
    <div id="htmlconsole" class="index_console"></div>
    <div id="admin_menu_content"></div>
</div>
<div id="page_debugging_panel" style="display: none; position: absolute; top: 10px; left:50%; width: 48%; font-size:11px;">
    <button type="button" id="button2" onclick="$('.page_console').toggleClass('hidden');">Toggle Console</button>
    <button type="button" id="button2" onclick="$('.page_console').html('');">Clear Console</button>
    <button type="button" id="button3" onclick="scrollConsole('page_console','top');">Top</button>
    <button type="button" id="button4" onclick="scrollConsole('page_console','up');">-</button>
    <button type="button" id="button5" onclick="scrollConsole('page_console','down');">+</button>
    <input type="checkbox" id="auto_scroll" value="on" checked="checked" onclick="toggleAutoScroll();"> Auto-Scroll
    <div id="widget_htmlconsole" class="page_console"></div>
</div>
<div id='mydiv'>
    <iframe width="100%" height="100%" id="iframe_id" frameborder="0" scrolling="no" src="portal.html"></iframe>
</div>
<script>
    localStorage.removeItem("tcp_listener_active");
    $( document ).ready(function() {
        var debug_interval = setInterval(function() {
            var roomId = localStorage.getItem("room_number");
            var debugRoomId = localStorage.getItem("debugRoomId");
            if (debugRoomId == 'all') {
                logIndexConsole("{bootup} Debug mode for ALL rooms!", LOG_MESSAGE_TYPES.milestone_completed);
                setDebugPanelState(null);
                clearInterval(debug_interval);
            }
            else if (roomId != null) {
                logIndexConsole("{bootup} Found room_number: " + roomId, LOG_MESSAGE_TYPES.milestone_completed);
                setDebugPanelState(null);
                clearInterval(debug_interval);
            }
        }, 500);

        logIndexConsole("{bootup} Starting TCP Listener for index/wrapper...");
        logIndexConsole("{bootup} DEPLOYED XAIT: " + currentXAIT, LOG_MESSAGE_TYPES.information);
        logIndexConsole("{bootup} SERVER MODE: " + COM_TYPE, LOG_MESSAGE_TYPES.information);

        hcap.property.getProperty({
            "key" : "xait_version",
            "onSuccess" : function(s) {
                logIndexConsole("{bootup} HCAP XAIT: " + s.value, LOG_MESSAGE_TYPES.information);
                var currentXaitLS = (localStorage.getItem("xait") ? parseInt(localStorage.getItem("xait")) : -1);

                mainMonitorObj.xait_version = s.value;
                localStorage.setItem("xait", mainMonitorObj.xait_version);
                if (currentXaitLS < mainMonitorObj.xait_version) {
                    logMilestoneEvent("XAIT from " + currentXaitLS + " to " + mainMonitorObj.xait_version);
                }

                // delay start-up to prevent duplicate milestone event timestamps
                setTimeout(function() {
                    -();
                    index_startup();
                }, 1000);

            },
            "onFailure" : function(f) {
                logIndexConsole("{bootup} onFailure : errorMessage = " + f.errorMessage);

                start_tcp();
                index_startup();
            }
        });
    });
</script>
<script>
    if (!IS_MIA_PROJECT) {
        var script = document.createElement("script"); // Make a script DOM node
        script.src = "resources/music/bgm.js"; // Set it's src to the provided URL
        document.head.appendChild(script); // Add it to the end of the head section of the page (could change 'head' to 'body'
    }
</script>
</body>
</html>
